<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SUNSTONE - Lung Health Monitoring</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:#f5f6fa;display:flex;justify-content:center;align-items:center;min-height:100vh}
    .container{max-width:1200px;width:100%;padding:20px}
    .page{display:none;background:#fff;border-radius:12px;box-shadow:0 4px 25px rgba(0,0,0,0.1);overflow:hidden}
    .page.active{display:block}
    .nav-btn{padding:10px 20px;border:2px solid #3b4998;background:#f8f9fa;color:#3b4998;border-radius:8px;cursor:pointer;font-weight:600;margin-right:10px;transition:0.3s}
    .nav-btn:hover,.nav-btn.active{background:#3b4998;color:#fff}
    .dashboard-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:2px solid #eee;flex-wrap:wrap}
    .dashboard-title{color:#3b4998;font-size:30px;font-weight:bold}
    .nav-links{display:flex;gap:5px;flex-wrap:wrap}
    .btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:0.3s}
    .btn-primary{background:#3b4998;color:#fff}
    .btn-primary:hover{background:#2d3875}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-danger:hover{background:#c82333}
    .btn-success{background:#28a745;color:#fff}
    .btn-success:hover{background:#218838}
    .btn-sm{padding:6px 10px;font-size:13px}
    .add-patient-section{background:#f8f9fa;padding:20px;border-radius:10px;margin:20px}
    .form-row{display:flex;gap:15px;margin-bottom:15px}
    .form-group{flex:1}
    .form-group label{font-weight:600;color:#333;display:block;margin-bottom:5px}
    .form-group input{width:100%;padding:10px;border:2px solid #ddd;border-radius:6px}
    .current-patient{background:#e3f2fd;padding:20px;border-left:4px solid #3b4998;border-radius:8px;margin:20px}
    .status-badge{padding:4px 12px;border-radius:12px;font-weight:600;font-size:12px;margin-left:10px}
    .status-waiting{background:#fff3cd;color:#856404}
    .status-processing{background:#cce5ff;color:#0066cc}
    .status-completed{background:#d4edda;color:#155724}
    .sensor-panel{background:#f8f9fa;padding:20px;border-radius:10px;margin:20px}
    .sensor-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:15px}
    .sensor-card{background:#fff;padding:15px;border-radius:8px;border-left:4px solid #3b4998;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .sensor-value{font-size:24px;font-weight:bold;color:#3b4998;margin:5px 0}
    .sensor-label{font-size:12px;color:#666;text-transform:uppercase}
    .result-section{background:#3b4998;color:white;padding:25px;border-radius:12px;margin:20px;display:none}
    .result-category{font-size:36px;font-weight:bold;margin:15px 0}
    .result-confidence{font-size:18px;margin-bottom:20px}
    .prob-bars{margin-top:20px}
    .prob-item{margin-bottom:10px}
    .prob-label{display:flex;justify-content:space-between;margin-bottom:5px;font-size:14px}
    .prob-bar{height:20px;background:rgba(255,255,255,0.2);border-radius:10px;overflow:hidden}
    .prob-fill{height:100%;background:#fff;transition:width 0.5s}
    .admin-page{padding:20px}
    .status-table{width:100%;border-collapse:collapse;margin-bottom:20px}
    .status-table th,.status-table td{padding:10px;border-bottom:1px solid #ddd;text-align:left}
    .status-table th{background:#f8f9fa;font-weight:600}
    .log-container{background:#f8f9fa;padding:10px;border-radius:8px;font-family:monospace;max-height:250px;overflow-y:auto;font-size:12px}
    .log-entry{border-bottom:1px dashed #ccc;padding:3px 0}
    table{width:100%;border-collapse:collapse;margin-top:15px}
    th,td{border-bottom:1px solid #ddd;padding:10px;text-align:left}
    th{background:#f8f9fa;font-weight:600}
    .toast{position:fixed;bottom:20px;right:20px;padding:15px 20px;background:#28a745;color:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);display:none;z-index:1000}
    .connection-indicator{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:5px}
    .conn-connected{background:#28a745}
    .conn-disconnected{background:#dc3545}
    .conn-connecting{background:#ffc107;animation:blink 1s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
    .expandable-row{background:#f8f9fa;display:none}
    .expandable-row.show{display:table-row}
    .expandable-content{padding:15px;font-size:12px}
    .sensor-readings-table{width:100%;margin-top:10px;font-size:11px}
    .sensor-readings-table th{background:#e3f2fd;padding:5px}
    .sensor-readings-table td{padding:5px;border-bottom:1px solid #ddd}
    .expand-btn{background:#3b4998;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px}
    .expand-btn:hover{background:#2d3875}
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN PAGE -->
    <div id="loginPage" class="page active" style="text-align:center;padding:50px">
      <h1 style="color:#3b4998;margin-bottom:30px;">SUNSTONE</h1>
      <form id="loginForm" style="max-width:350px;margin:auto;">
        <input type="email" id="username" placeholder="Email" required style="padding:12px;width:100%;margin-bottom:15px;border:2px solid #ccc;border-radius:6px;">
        <input type="password" id="password" placeholder="Password" required style="padding:12px;width:100%;margin-bottom:15px;border:2px solid #ccc;border-radius:6px;">
        <button class="btn btn-primary" style="width:100%;" type="submit">Masuk</button>
      </form>
      <p id="loginError" style="color:red;margin-top:10px;"></p>
      <p style="color:#999;font-size:13px;margin-top:20px;">Browser-Centric ‚Ä¢ Offline-First ‚Ä¢ MQTT Real-time</p>
    </div>

    <!-- DASHBOARD PAGE -->
    <div id="dashboardPage" class="page">
      <div class="dashboard-header">
        <h1 class="dashboard-title">DASHBOARD</h1>
        <div class="nav-links">
          <button class="nav-btn active" onclick="showDashboard(event)">Dashboard</button>
          <button class="nav-btn" onclick="showHistory(event)">Riwayat</button>
          <button class="nav-btn" onclick="showAdmin(event)">Admin</button>
          <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>
      </div>

      <!-- Add Patient Form -->
      <div id="addPatientSection" class="add-patient-section">
        <h3>Tambah Pasien Baru</h3>
        <form id="patientForm">
          <div class="form-row">
            <div class="form-group">
              <label>Nama Lengkap</label>
              <input id="patientName" type="text" required>
            </div>
            <div class="form-group">
              <label>Umur (tahun)</label>
              <input id="patientAge" type="number" required min="1" max="120">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>No HP</label>
              <input id="patientPhone" type="text" required pattern="[0-9]{10,13}" placeholder="08123456789">
            </div>
            <div class="form-group">
              <label>Batang Rokok per Hari</label>
              <input id="brinkmanCigPerDay" type="number" required min="0" placeholder="Contoh: 20">
            </div>
            <div class="form-group">
              <label>Lama Merokok (tahun)</label>
              <input id="brinkmanYearsSmoke" type="number" required min="0" placeholder="Contoh: 30">
            </div>
          </div>
          <button class="btn btn-primary" type="submit">Mulai Sesi</button>
        </form>
      </div>

      <!-- Current Patient Info -->
      <div id="currentPatientSection" class="current-patient" style="display:none">
        <h4>üë§ Pasien Aktif <span id="patientStatus" class="status-badge status-waiting">Menunggu Data</span></h4>
        <p><b>Nama:</b> <span id="currentName">-</span> | <b>Umur:</b> <span id="currentAge">-</span> | <b>HP:</b> <span id="currentPhone">-</span> | <b>Brinkman:</b> <span id="currentBrinkman">-</span></p>
        <p style="margin-top:10px;color:#666;font-size:13px">
          <span class="connection-indicator" id="mqttIndicator"></span>
          <span id="mqttStatusText">Connecting to MQTT...</span>
        </p>
        <button class="btn btn-danger" onclick="finishSession()">Selesai & Tutup Sesi</button>
      </div>

      <!-- Sensor Panel -->
      <div id="sensorPanel" class="sensor-panel" style="display:none">
        <h3>üìä Data Sensor Real-time</h3>
        <p id="lastUpdate" style="color:#666;font-size:13px;margin-top:5px">Menunggu data dari ESP32...</p>
        <div class="sensor-grid">
          <div class="sensor-card">
            <div class="sensor-label">MG-811 (CO‚ÇÇ)</div>
            <div class="sensor-value" id="mg811">-</div>
          </div>
          <div class="sensor-card">
            <div class="sensor-label">MQ-7 (CO)</div>
            <div class="sensor-value" id="mq7">-</div>
          </div>
          <div class="sensor-card">
            <div class="sensor-label">MQ-3 (Etanol)</div>
            <div class="sensor-value" id="mq3">-</div>
          </div>
          <div class="sensor-card">
            <div class="sensor-label">MQ-135 (VOC)</div>
            <div class="sensor-value" id="mq135">-</div>
          </div>
        </div>
      </div>

      <!-- Result Section -->
      <div id="resultSection" class="result-section">
        <h3>üî¨ Hasil Analisis PPOK</h3>
        <div class="result-category" id="resultCategory">-</div>
        <div class="result-confidence">Confidence: <span id="resultConfidence">-</span>%</div>
        
        <div class="prob-bars">
          <div class="prob-item">
            <div class="prob-label"><span>Rendah</span><span id="probRendah">0%</span></div>
            <div class="prob-bar"><div class="prob-fill" id="probRendahBar" style="width:0%"></div></div>
          </div>
          <div class="prob-item">
            <div class="prob-label"><span>Sedang</span><span id="probSedang">0%</span></div>
            <div class="prob-bar"><div class="prob-fill" id="probSedangBar" style="width:0%"></div></div>
          </div>
          <div class="prob-item">
            <div class="prob-label"><span>Tinggi</span><span id="probTinggi">0%</span></div>
            <div class="prob-bar"><div class="prob-fill" id="probTinggiBar" style="width:0%"></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- HISTORY PAGE -->
    <div id="historyPage" class="page">
      <div class="dashboard-header">
        <h1 class="dashboard-title">RIWAYAT PEMERIKSAAN</h1>
        <div class="nav-links">
          <button class="nav-btn" onclick="showDashboard(event)">Dashboard</button>
          <button class="nav-btn active" onclick="showHistory(event)">Riwayat</button>
          <button class="nav-btn" onclick="showAdmin(event)">Admin</button>
          <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>
      </div>
      <div style="padding:20px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
          <button class="btn btn-primary" onclick="loadHistory()">üîÑ Refresh Data</button>
          <span id="syncIndicator" style="color:#999;font-size:13px"></span>
        </div>
        <table>
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>Nama Pasien</th>
              <th>Umur</th>
              <th>No HP</th>
              <th>Brinkman</th>
              <th>Hasil PPOK</th>
              <th>Confidence</th>
              <th>Status</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr><td colspan="9" style="text-align:center">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ADMIN PAGE -->
    <div id="adminPage" class="page">
      <div class="admin-page">
        <h1 style="color:#3b4998;margin-bottom:10px;">‚öôÔ∏è ADMIN PANEL</h1>
        <div class="nav-links" style="margin-bottom:15px">
          <button class="nav-btn" onclick="showDashboard(event)">Dashboard</button>
          <button class="nav-btn" onclick="showHistory(event)">Riwayat</button>
          <button class="nav-btn active" onclick="showAdmin(event)">Admin</button>
          <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>
        
        <h3>System Status</h3>
        <table class="status-table">
          <tr><th>Component</th><th>Status</th><th>Detail</th></tr>
          <tr>
            <td>üåê MQTT Broker</td>
            <td id="mqttBrokerStatus">üü° Checking...</td>
            <td id="mqttBrokerDetail">-</td>
          </tr>
          <tr>
            <td>üóÑÔ∏è IndexedDB</td>
            <td id="dbStatus">üü° Checking...</td>
            <td id="dbDetail">-</td>
          </tr>
          <tr>
            <td>ü§ñ ONNX Model</td>
            <td id="modelStatus">üü° Checking...</td>
            <td id="modelDetail">-</td>
          </tr>
          <tr>
            <td>üì° ESP32 Data</td>
            <td id="esp32Status">üü° Waiting...</td>
            <td id="esp32Detail">-</td>
          </tr>
        </table>
        
        <button class="btn btn-primary" onclick="refreshSystemStatus()">Refresh Status</button>
        
        <h3 style="margin-top:30px;">System Logs</h3>
        <div id="logContainer" class="log-container">
          <div class="log-entry">[INIT] System initializing...</div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.20.0/dist/ort.min.js"></script>
<script src="https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js"></script>
<script>
// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
  users: {
    'pkmkc.sunstone@gmail.com': {
      passwordHash: '8419742cd9b8e11b7860c229838a61ac32b3ba9a8aa2d6b84dfade6cf941c490',
      name: 'Admin SUNSTONE'
    }
  },
  modelUrl: 'best_model.onnx',
  mqtt: {
    broker: 'wss://broker.hivemq.com:8884/mqtt',
    clientId: 'sunstone_web_' + Math.random().toString(16).substr(2, 8),
    topics: {
      sensor: 'sunstone/esp32/+/sensor',
      cmd: 'sunstone/esp32/ESP01/cmd',
      statusRequest: 'sunstone/esp32/+/status_request'
    }
  }
};

// ============================================
// GLOBAL STATE
// ============================================
let db = null;
let onnxSession = null;
let currentSessionId = null;
let lastSensorTimestamp = null;
let mqttClient = null;
let mqttConnected = false;

const AWS_HISTORY = {
  baseUrl: 'https://znnlzeaog9.execute-api.ap-southeast-1.amazonaws.com/prod',
  apiKey: ''
};

// ============================================
// UTILITY FUNCTIONS
// ============================================
async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

function addLog(message) {
  const logContainer = document.getElementById('logContainer');
  if (!logContainer) return;
  const timestamp = new Date().toLocaleTimeString('id-ID');
  const logEntry = document.createElement('div');
  logEntry.className = 'log-entry';
  logEntry.textContent = `[${timestamp}] ${message}`;
  logContainer.appendChild(logEntry);
  logContainer.scrollTop = logContainer.scrollHeight;
  console.log(`[${timestamp}] ${message}`);
}

function showToast(message, duration = 3000) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, duration);
}

function generateSessionId(name, phone) {
  const cleanName = name.replace(/\s+/g, '_');
  return `${cleanName}_${phone}_${Date.now()}`;
}

// ============================================
// INDEXEDDB
// ============================================
async function initIndexedDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('SunstoneDB', 1);
    request.onerror = () => reject(request.error);
    request.onsuccess = () => { db = request.result; addLog('‚úÖ IndexedDB initialized'); resolve(db); };
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains('sessions')) {
        const sessionsStore = db.createObjectStore('sessions', { keyPath: 'id', autoIncrement: true });
        sessionsStore.createIndex('sessionId', 'sessionId', { unique: true });
        sessionsStore.createIndex('status', 'status', { unique: false });
      }
      if (!db.objectStoreNames.contains('sensors')) {
        const sensorsStore = db.createObjectStore('sensors', { keyPath: 'id', autoIncrement: true });
        sensorsStore.createIndex('sessionId', 'sessionId', { unique: false });
      }
      if (!db.objectStoreNames.contains('results')) {
        const resultsStore = db.createObjectStore('results', { keyPath: 'id', autoIncrement: true });
        resultsStore.createIndex('sessionId', 'sessionId', { unique: false });
      }
    };
  });
}
async function saveSession(sessionData){const tx=db.transaction(['sessions'],'readwrite');const store=tx.objectStore('sessions');return new Promise((resolve)=>{store.add(sessionData);resolve(sessionData.sessionId);});}
async function updateSession(sessionId, updates){const tx=db.transaction(['sessions'],'readwrite');const store=tx.objectStore('sessions');const index=store.index('sessionId');return new Promise((resolve)=>{const request=index.get(sessionId);request.onsuccess=()=>{const session=request.result;if(session){Object.assign(session,updates);store.put(session);resolve(session);}};});}
async function getActiveSession(){const tx=db.transaction(['sessions'],'readonly');const store=tx.objectStore('sessions');const index=store.index('status');return new Promise((resolve)=>{const request=index.get('OPEN');request.onsuccess=()=>resolve(request.result||null);request.onerror=()=>resolve(null);});}
async function saveSensorData(sensorData){const tx=db.transaction(['sensors'],'readwrite');const store=tx.objectStore('sensors');return new Promise((resolve)=>{store.add(sensorData);resolve();});}
async function saveResult(resultData){const tx=db.transaction(['results'],'readwrite');const store=tx.objectStore('results');return new Promise((resolve)=>{store.add(resultData);resolve();});}
async function getAllSessions(){const tx=db.transaction(['sessions'],'readonly');const store=tx.objectStore('sessions');return new Promise((resolve)=>{const request=store.getAll();request.onsuccess=()=>resolve(request.result||[]);request.onerror=()=>resolve([]);});}

// ============================================
// MQTT
// ============================================
function connectMQTT() {
  addLog('üîå Connecting to MQTT broker...');
  try {
    mqttClient = mqtt.connect(CONFIG.mqtt.broker, {
      clientId: CONFIG.mqtt.clientId,
      clean: true,
      reconnectPeriod: 3000
    });
    
    mqttClient.on('connect', () => {
      mqttConnected = true;
      addLog('‚úÖ MQTT connected');
      updateMQTTIndicator(true);
      
      mqttClient.subscribe(CONFIG.mqtt.topics.sensor, (err) => { 
        if (!err) addLog('üì° Subscribed to: ' + CONFIG.mqtt.topics.sensor); 
      });
      
      mqttClient.subscribe('sunstone/esp32/+/status_request', (err) => {
        if (!err) addLog('üì° Subscribed to status requests');
      });
    });
    
    mqttClient.on('message', (topic, payload) => {
      try {
        const data = JSON.parse(payload.toString());
        addLog(`üì© MQTT Message - Topic: ${topic}`);
        addLog(`üì© Payload: ${JSON.stringify(data)}`);
        
        if (topic.includes('/sensor')) {
          addLog(`üì• Processing sensor data from: ${data.device_id}`);
          processSensorData(data);
        } else if (topic.includes('/status_request')) {
          addLog(`üì• Processing status request from: ${data.device_id}`);
          handleStatusRequest(data);
        } else {
          addLog(`‚ö†Ô∏è Unknown topic pattern: ${topic}`);
        }
      } catch (e) {
        addLog('‚ùå Invalid JSON from MQTT: ' + e.message);
      }
    });
    
    mqttClient.on('error', (err) => { 
      addLog('‚ùå MQTT error: ' + err.message); 
      updateMQTTIndicator(false); 
    });
    
    mqttClient.on('close', () => { 
      mqttConnected = false; 
      addLog('üîå MQTT disconnected'); 
      updateMQTTIndicator(false); 
    });
    
    mqttClient.on('reconnect', () => { 
      addLog('üîÑ MQTT reconnecting...'); 
      updateMQTTIndicator('connecting'); 
    });
  } catch (err) {
    addLog('‚ùå Failed to connect MQTT: ' + err.message);
    updateMQTTIndicator(false);
  }
}
function updateMQTTIndicator(status) {
  const indicator = document.getElementById('mqttIndicator');
  const text = document.getElementById('mqttStatusText');
  if (!indicator || !text) return;
  if (status === true) { indicator.className='connection-indicator conn-connected'; text.textContent='MQTT Connected'; }
  else if (status === 'connecting') { indicator.className='connection-indicator conn-connecting'; text.textContent='MQTT Reconnecting...'; }
  else { indicator.className='connection-indicator conn-disconnected'; text.textContent='MQTT Disconnected'; }
}
function sendMQTTCommand(cmd) {
  if (mqttClient && mqttConnected) {
    const topic = CONFIG.mqtt.topics.cmd;
    const payload = JSON.stringify(cmd);
    addLog(`üì§ Publishing to: ${topic}`);
    addLog(`üì§ Payload: ${payload}`);
    mqttClient.publish(topic, payload, { qos: 1 }, (err) => {
      if (err) addLog('‚ùå Publish failed: ' + err.message);
      else { addLog('‚úÖ Command published successfully'); showToast('üì§ Command sent to ESP32', 2000); }
    });
  } else { addLog('‚ùå Cannot send command: MQTT not connected'); showToast('‚ùå MQTT not connected!', 2000); }
}
async function handleStatusRequest(data) {
  addLog('üîç Processing status request...');
  addLog(`üîç Request from device: ${data.device_id}`);
  const activeSession = await getActiveSession();
  if (activeSession && activeSession.status === 'OPEN') {
    addLog(`‚úÖ Found active session: ${activeSession.name} (${activeSession.sessionId})`);
    addLog('üì¢ Sending session_ready command...');
    sendMQTTCommand({ action:'session_ready', session_id:activeSession.sessionId, patient_name:activeSession.name });
  } else {
    addLog('‚ö†Ô∏è No active session found in database');
    addLog('üì¢ Sending no_session command...');
    sendMQTTCommand({ action:'no_session' });
  }
}

// ============================================
// ONNX MODEL
// ============================================
async function loadONNXModel() {
  try {
    addLog('üì¶ Loading ONNX model from: ' + CONFIG.modelUrl);
    onnxSession = await ort.InferenceSession.create(CONFIG.modelUrl);
    addLog('‚úÖ ONNX model loaded successfully!');
    addLog('‚úÖ Model inputs: ' + JSON.stringify(onnxSession.inputNames));
    addLog('‚úÖ Model outputs: ' + JSON.stringify(onnxSession.outputNames));
    return true;
  } catch (error) {
    addLog('‚ùå ONNX model load failed: ' + error.message);
    addLog('‚ö†Ô∏è  Using fallback logic instead');
    return false;
  }
}

async function runInference(sensorData) {
  addLog('ü§ñ Running inference (3-class model)...');
  addLog(`üìä Input data: MG811=${sensorData.mg811}, MQ7=${sensorData.mq7}, MQ3=${sensorData.mq3}, MQ135=${sensorData.mq135}`);

  const classLabels = ['Rendah', 'Sedang', 'Tinggi'];

  if (!onnxSession) {
    const avg = (sensorData.mg811 + sensorData.mq7 + sensorData.mq3 + sensorData.mq135) / 4;
    const idx = avg < 200 ? 0 : (avg < 350 ? 1 : 2);
    const category = classLabels[idx];
    const probs3 = [idx===0?1:0, idx===1?1:0, idx===2?1:0];
    return {
      category,
      confidence: 1.0,
      probabilities: { rendah: probs3[0], sedang: probs3[1], tinggi: probs3[2] }
    };
  }

  const inputName = onnxSession.inputNames[0] || 'float_input';
  const outs = onnxSession.outputNames;
  const labelName = outs.find(n => /label/i.test(n)) || 'label';
  const probName  = outs.find(n => /prob/i.test(n))  || 'probabilities';

  const input = new Float32Array([sensorData.mg811, sensorData.mq7, sensorData.mq3, sensorData.mq135]);
  const tensor = new ort.Tensor('float32', input, [1, 4]);
  const feeds = { [inputName]: tensor };

  addLog('ü§ñ ORT run #1 (label only)‚Ä¶');
  const res1 = await onnxSession.run(feeds, { [labelName]: null });
  let labelIdx = 0;
  const labelVal = res1[labelName];
  if (labelVal && labelVal.data) {
    const raw = labelVal.data[0];
    labelIdx = Number(typeof raw === 'bigint' ? raw : raw ?? 0);
  } else if (Array.isArray(labelVal)) {
    labelIdx = Number(labelVal[0] ?? 0);
  }

  let category = classLabels[labelIdx] ?? 'Rendah';

  addLog('ü§ñ ORT run #2 (probabilities only)‚Ä¶');
  const res2 = await onnxSession.run(feeds, { [probName]: null });
  const probT = res2[probName];

  let p0 = 0, p1 = 0, p2 = 0;
  if (probT && probT.data) {
    const d = probT.data;
    if (d.length >= 3) { p0 = Number(d[0]); p1 = Number(d[1]); p2 = Number(d[2]); }
  } else if (Array.isArray(probT)) {
    if (probT.length >= 3) { p0 = Number(probT[0]); p1 = Number(probT[1]); p2 = Number(probT[2]); }
  }

  const probsArr = [p0, p1, p2];
  const maxIdx = probsArr.indexOf(Math.max(...probsArr));
  if (maxIdx >= 0) category = classLabels[maxIdx];

  const confidence = Math.max(...probsArr) || 0;

  const probabilities = { rendah: p0, sedang: p1, tinggi: p2 };

  addLog(`‚úÖ ONNX result: ${category} (${(confidence*100).toFixed(1)}%)`);
  return { category, confidence, probabilities };
}

// ============================================
// LOGIN
// ============================================
document.getElementById('loginForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const email = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  const passwordHash = await hashPassword(password);
  const user = CONFIG.users[email];
  if (user && user.passwordHash === passwordHash) {
    localStorage.setItem('authToken', btoa(`${email}:${Date.now()}`));
    localStorage.setItem('userName', user.name);
    addLog(`‚úÖ Login: ${user.name}`);
    showToast('‚úÖ Login berhasil!');
    document.getElementById('loginError').textContent = '';
    document.getElementById('loginPage').classList.remove('active');
    document.getElementById('dashboardPage').classList.add('active');
    await restoreSession();
  } else {
    document.getElementById('loginError').textContent = '‚ùå Email atau password salah!';
    addLog('‚ùå Login gagal');
  }
});

function logout() {
  if (currentSessionId && !confirm('Sesi masih aktif. Yakin logout?')) return;
  localStorage.removeItem('authToken');
  localStorage.removeItem('userName');
  localStorage.removeItem('SESSION_KEY');
  currentSessionId = null;
  if (mqttClient) { mqttClient.end(); mqttClient = null; }
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('loginPage').classList.add('active');
  addLog('Logout');
  showToast('Logout berhasil');
}

// ============================================
// SESSION MANAGEMENT
// ============================================
document.getElementById('patientForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const existingSession = await getActiveSession();
  if (existingSession) { alert(`‚ö†Ô∏è Masih ada sesi aktif: ${existingSession.name}. Tutup sesi tersebut dulu!`); return; }
  const name = document.getElementById('patientName').value;
  const age = parseInt(document.getElementById('patientAge').value);
  const phone = document.getElementById('patientPhone').value;
  const brinkmanCigPerDay = parseInt(document.getElementById('brinkmanCigPerDay').value);
  const brinkmanYearsSmoke = parseInt(document.getElementById('brinkmanYearsSmoke').value);
  const sessionId = generateSessionId(name, phone);
  const sessionData = {
    sessionId, name, age, phone, 
    brinkmanCigPerDay, brinkmanYearsSmoke,
    status:'OPEN',
    timestamp:new Date().toISOString(), device_id:'ESP01',
    lastResultCategory:null, lastResultConfidence:null, lastProbabilities:null
  };
  await saveSession(sessionData);
  localStorage.setItem('SESSION_KEY', sessionId);
  currentSessionId = sessionId;
  document.getElementById('currentName').textContent = name;
  document.getElementById('currentAge').textContent = age;
  document.getElementById('currentPhone').textContent = phone;
  document.getElementById('currentBrinkman').textContent = `${brinkmanCigPerDay} btg/hari √ó ${brinkmanYearsSmoke} thn`;
  document.getElementById('addPatientSection').style.display = 'none';
  document.getElementById('currentPatientSection').style.display = 'block';
  document.getElementById('sensorPanel').style.display = 'block';
  document.getElementById('mg811').textContent = '-';
  document.getElementById('mq7').textContent = '-';
  document.getElementById('mq3').textContent = '-';
  document.getElementById('mq135').textContent = '-';
  document.getElementById('lastUpdate').textContent = 'Menunggu data dari ESP32...';
  document.getElementById('lastUpdate').style.color = '#666';
  document.getElementById('resultSection').style.display = 'none';
  addLog(`‚úÖ Sesi dimulai: ${name}`);
  showToast('‚úÖ Sesi berhasil dibuat!');
  addLog('üì¢ Broadcasting session_ready to ESP32...');
  sendMQTTCommand({ action:'session_ready', session_id:sessionId, patient_name:name });
  document.getElementById('patientForm').reset();
});


async function finishSession() {
  if (!currentSessionId) return;
  if (!confirm('Yakin tutup sesi?')) return;

  await updateSession(currentSessionId, {
    status: 'CLOSED',
    finishTimestamp: new Date().toISOString()
  });
  sendMQTTCommand({ action: 'close_session' });

  const allSessions = await getAllSessions();
  const closed = allSessions.find(s => s.sessionId === currentSessionId && s.status === 'CLOSED');
  if (closed) {
    try {
      const sensors = await getSensorsBySession(currentSessionId);
      const results = await getResultsBySession(currentSessionId);
      
      const sensorReadings = sensors.map(s => ({
        timestamp: s.timestamp,
        mg811: s.mg811 || 0,
        mq7: s.mq7 || 0,
        mq3: s.mq3 || 0,
        mq135: s.mq135 || 0
      }));

      const payload = {
        sessionId: closed.sessionId,
        timestamp: closed.timestamp,
        patientData: {
          name: closed.name,
          age: closed.age,
          gender: 'L',
          phone: closed.phone,
          brinkmanCigPerDay: closed.brinkmanCigPerDay,
          brinkmanYearsSmoke: closed.brinkmanYearsSmoke
        },
        sensorReadings: sensorReadings,
        result: {
          category: closed.lastResultCategory || 'Unknown',
          confidence: closed.lastResultConfidence || 0,
          probabilities: closed.lastProbabilities || {}
        }
      };

      const response = await fetch(AWS_HISTORY.baseUrl + '/save-session', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        addLog(`‚òÅÔ∏è Session uploaded to AWS: ${closed.sessionId}`);
        showToast('‚òÅÔ∏è Data tersimpan ke cloud!', 2000);
      } else {
        throw new Error('AWS sync failed: ' + response.status);
      }
    } catch (e) {
      addLog(`‚ùå Sync error: ${e.message}`);
      showToast('‚ö†Ô∏è Gagal sync ke cloud', 3000);
    }
  }

  resetDashboard();
  addLog(`‚úÖ Sesi selesai`);
  showToast('‚úÖ Sesi ditutup!');
  setTimeout(()=>{ sendMQTTCommand({ action:'no_session' }); }, 1000);
}

function resetDashboard() {
  currentSessionId = null;
  localStorage.removeItem('SESSION_KEY');
  document.getElementById('addPatientSection').style.display = 'block';
  document.getElementById('currentPatientSection').style.display = 'none';
  document.getElementById('sensorPanel').style.display = 'none';
  document.getElementById('resultSection').style.display = 'none';
}

async function restoreSession() {
  const sessionKey = localStorage.getItem('SESSION_KEY');
  if (!sessionKey) return;
  const tx = db.transaction(['sessions'],'readonly');
  const store = tx.objectStore('sessions');
  const index = store.index('sessionId');
  return new Promise((resolve) => {
    const request = index.get(sessionKey);
    request.onsuccess = () => {
      const session = request.result;
      if (session && session.status === 'OPEN') {
        currentSessionId = session.sessionId;
        document.getElementById('currentName').textContent = session.name;
        document.getElementById('currentAge').textContent = session.age;
        document.getElementById('currentPhone').textContent = session.phone;
        document.getElementById('currentBrinkman').textContent = `${session.brinkmanCigPerDay} btg/hari √ó ${session.brinkmanYearsSmoke} thn`;
        document.getElementById('addPatientSection').style.display = 'none';
        document.getElementById('currentPatientSection').style.display = 'block';
        document.getElementById('sensorPanel').style.display = 'block';
        if (session.lastResultCategory) {
          displayResult({ category:session.lastResultCategory, confidence:session.lastResultConfidence, probabilities:session.lastProbabilities });
        }
        addLog(`‚úÖ Sesi dipulihkan: ${session.name}`);
      }
      resolve();
    };
  });
}

// ============================================
// SENSOR DATA PROCESSING
// ============================================
async function processSensorData(sensorData) {
  if (!currentSessionId) { addLog('‚ö†Ô∏è Data ditolak: tidak ada sesi aktif'); return; }
  const activeSession = await getActiveSession();
  if (!activeSession || activeSession.sessionId !== currentSessionId) { addLog('‚ö†Ô∏è Data ditolak: sesi tidak valid'); return; }

  lastSensorTimestamp = new Date();
  const sensorRecord = {
    sessionId: currentSessionId,
    timestamp: sensorData.ts || new Date().toISOString(),
    mg811: sensorData.mg811, mq7: sensorData.mq7, mq3: sensorData.mq3, mq135: sensorData.mq135
  };
  await saveSensorData(sensorRecord);

  document.getElementById('mg811').textContent = sensorData.mg811;
  document.getElementById('mq7').textContent = sensorData.mq7;
  document.getElementById('mq3').textContent = sensorData.mq3;
  document.getElementById('mq135').textContent = sensorData.mq135;

  document.getElementById('lastUpdate').textContent = '‚è±Ô∏è Update: baru saja';
  document.getElementById('lastUpdate').style.color = '#28a745';
  document.getElementById('patientStatus').textContent = 'Processing';
  document.getElementById('patientStatus').className = 'status-badge status-processing';

  addLog('üöÄ Starting inference process...');
  try {
    const result = await runInference(sensorData);
    if (result) {
      const resultData = {
        sessionId: currentSessionId, timestamp:new Date().toISOString(),
        category: result.category, confidence: result.confidence, probabilities: result.probabilities
      };
      await saveResult(resultData);
      await updateSession(currentSessionId, {
        lastResultCategory: result.category,
        lastResultConfidence: result.confidence,
        lastProbabilities: result.probabilities
      });
      displayResult(result);
      addLog(`üî¨ FINAL: ${result.category} (${(result.confidence * 100).toFixed(1)}%)`);
    } else {
      addLog('‚ùå Inference returned null result');
    }
  } catch (err) {
    addLog('‚ùå Inference error: ' + (err?.message || err));
  }
}

function displayResult(result) {
  addLog('üé® displayResult() called');
  addLog(`üé® Category: ${result.category}, Confidence: ${result.confidence}`);
  const resultSection = document.getElementById('resultSection');
  if (!resultSection) { addLog('‚ùå resultSection element not found!'); return; }
  resultSection.style.display = 'block';
  addLog('‚úÖ Result section displayed');

  document.getElementById('resultCategory').textContent = result.category;
  document.getElementById('resultConfidence').textContent = (result.confidence * 100).toFixed(1);

  document.getElementById('patientStatus').textContent = 'Selesai';
  document.getElementById('patientStatus').className = 'status-badge status-completed';

  if (result.probabilities) {
    const probs = result.probabilities;
    document.getElementById('probRendah').textContent = (probs.rendah * 100).toFixed(1) + '%';
    document.getElementById('probRendahBar').style.width = (probs.rendah * 100) + '%';
    document.getElementById('probSedang').textContent = (probs.sedang * 100).toFixed(1) + '%';
    document.getElementById('probSedangBar').style.width = (probs.sedang * 100) + '%';
    document.getElementById('probTinggi').textContent = (probs.tinggi * 100).toFixed(1) + '%';
    document.getElementById('probTinggiBar').style.width = (probs.tinggi * 100) + '%';
  }
  
  sendResultToESP32(result);
  
  addLog('‚úÖ displayResult() complete');
}

function sendResultToESP32(result) {
  if (!mqttClient || !mqttConnected) {
    addLog('‚ö†Ô∏è Cannot send result: MQTT not connected');
    return;
  }

  const resultPayload = {
    action: 'result',
    category: result.category,
    confidence: result.confidence,
    timestamp: new Date().toISOString()
  };

  const topic = 'sunstone/esp32/ESP01/cmd';
  mqttClient.publish(topic, JSON.stringify(resultPayload), { qos: 1 }, (err) => {
    if (err) {
      addLog('‚ùå Failed to send result to ESP32: ' + err.message);
    } else {
      addLog('‚úÖ Result sent to ESP32: ' + result.category);
      showToast('üì§ Hasil dikirim ke alat', 2000);
    }
  });
}

// ============================================
// NAVIGATION
// ============================================
function showDashboard(e) {switchPage('dashboardPage', e);}
function showHistory(e) {switchPage('historyPage', e); loadHistory();}
function showAdmin(e) {switchPage('adminPage', e); refreshSystemStatus();}
function switchPage(pageId, event) {
  if (event) { document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); }
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
}

// ============================================
// HISTORY & ADMIN
// ============================================
async function getSensorsBySession(sessionId) {
  return new Promise((resolve) => {
    const tx = db.transaction(['sensors'], 'readonly');
    const store = tx.objectStore('sensors');
    const index = store.index('sessionId');
    const req = index.getAll(IDBKeyRange.only(sessionId));
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => resolve([]);
  });
}
async function getResultsBySession(sessionId) {
  return new Promise((resolve) => {
    const tx = db.transaction(['results'], 'readonly');
    const store = tx.objectStore('results');
    const index = store.index('sessionId');
    const req = index.getAll(IDBKeyRange.only(sessionId));
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => resolve([]);
  });
}

function toggleReadings(sessionId) {
  const row = document.getElementById('readings-' + sessionId);
  if (row) {
    row.classList.toggle('show');
  }
}

async function loadHistory() {
  const tbody = document.getElementById('historyBody');
  const syncIndicator = document.getElementById('syncIndicator');
  tbody.innerHTML = '<tr><td colspan="9" style="text-align:center">Loading...</td></tr>';
  syncIndicator.textContent = 'Mengambil data dari cloud...';

  try {
    const response = await fetch(AWS_HISTORY.baseUrl + '/get-history');
    if (!response.ok) throw new Error('Failed to fetch: ' + response.status);
    
    const sessions = await response.json();
    
    if (!sessions || sessions.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" style="text-align:center">Belum ada riwayat</td></tr>';
      syncIndicator.textContent = 'Tidak ada data';
      return;
    }

    tbody.innerHTML = sessions.map(session => {
      const date = new Date(session.timestamp).toLocaleString('id-ID');
      const resultCategory = session.lastResultCategory || '-';
      const resultConfidence = session.lastResultConfidence;
      const conf = resultConfidence != null ? (Number(resultConfidence) * 100).toFixed(1) + '%' : '-';
      
      const cigPerDay = session.brinkmanCigPerDay || '-';
      const yearsSmoke = session.brinkmanYearsSmoke || '-';
      const brinkmanDisplay = `${cigPerDay} btg/hari | ${yearsSmoke} thn`;
      
      const readings = session.sensorReadings || [];
      const readingsCount = session.readingsCount || readings.length;
      const hasReadings = readingsCount > 0;
      
      let mainRow = `
        <tr>
          <td>${date}</td>
          <td>${session.patientName || '-'}</td>
          <td>${session.patientAge || '-'}</td>
          <td>${session.phone || '-'}</td>
          <td>${brinkmanDisplay}</td>
          <td><strong>${resultCategory}</strong></td>
          <td>${conf}</td>
          <td>
            <span class="status-badge ${session.status === 'OPEN' ? 'status-processing' : 'status-completed'}">
              ${session.status || 'CLOSED'}
            </span>
          </td>
          <td>
            ${hasReadings ? `<button class="expand-btn" onclick="toggleReadings('${session.sessionId}')">üìä ${readingsCount} data</button>` : '<em style="color:#999">No data</em>'}
            <button class="btn btn-danger btn-sm" onclick="deleteHistorySession('${session.sessionId}')">üóëÔ∏è</button>
          </td>
        </tr>`;
      
      if (hasReadings) {
        mainRow += `
        <tr id="readings-${session.sessionId}" class="expandable-row">
          <td colspan="9">
            <div class="expandable-content">
              <strong>üìä Data Sensor (${readingsCount} pembacaan)</strong>
              <table class="sensor-readings-table">
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Waktu</th>
                    <th>MG-811 (CO‚ÇÇ)</th>
                    <th>MQ-7 (CO)</th>
                    <th>MQ-3 (Etanol)</th>
                    <th>MQ-135 (VOC)</th>
                  </tr>
                </thead>
                <tbody>
                  ${readings.map((r, idx) => `
                    <tr>
                      <td>${idx + 1}</td>
                      <td>${new Date(r.readingTimestamp || r.timestamp).toLocaleTimeString('id-ID')}</td>
                      <td>${Math.round(r.mg811 || 0)}</td>
                      <td>${Math.round(r.mq7 || 0)}</td>
                      <td>${Math.round(r.mq3 || 0)}</td>
                      <td>${Math.round(r.mq135 || 0)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </td>
        </tr>`;
      }
      
      return mainRow;
    }).join('');

    syncIndicator.textContent = `‚úÖ ${sessions.length} data ‚Ä¢ ${new Date().toLocaleTimeString('id-ID')}`;
    addLog(`üìã Loaded ${sessions.length} sessions from AWS`);
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:red">‚ùå Error: ${err.message}</td></tr>`;
    syncIndicator.textContent = '‚ùå Gagal mengambil data';
    addLog('‚ùå loadHistory error: ' + err.message);
  }
}

async function refreshSystemStatus() {
  addLog('üîç Checking system...');
  if (mqttConnected) updateStatus('mqttBroker', true, 'Connected to ' + CONFIG.mqtt.broker);
  else updateStatus('mqttBroker', false, 'Disconnected');
  if (db) {
    const sessions = await getAllSessions();
    updateStatus('db', true, `${sessions.length} sessions`);
  } else updateStatus('db', false, 'Not initialized');
  if (onnxSession) updateStatus('model', true, 'Loaded');
  else updateStatus('model', null, 'Using fallback');
  if (lastSensorTimestamp) {
    const secondsAgo = Math.floor((new Date() - lastSensorTimestamp)/1000);
    if (secondsAgo < 10) updateStatus('esp32', true, `Active (${secondsAgo}s ago)`);
    else updateStatus('esp32', null, `Idle (${secondsAgo}s ago)`);
  } else updateStatus('esp32', null, 'No data yet');
}
function updateStatus(service, isOk, detail) {
  const statusEl = document.getElementById(`${service}Status`);
  const detailEl = document.getElementById(`${service}Detail`);
  if (isOk === true) { statusEl.textContent='üü¢ OK'; statusEl.style.color='green'; }
  else if (isOk === false) { statusEl.textContent='üî¥ Error'; statusEl.style.color='red'; }
  else { statusEl.textContent='üü° Warning'; statusEl.style.color='orange'; }
  if (detailEl) detailEl.textContent = detail || '-';
}

async function deleteHistorySession(sessionId) {
  if (!confirm('Yakin hapus riwayat ini dari cloud?')) return;
  
  try {
    const response = await fetch(AWS_HISTORY.baseUrl + '/delete-session/' + encodeURIComponent(sessionId), {
      method: 'DELETE'
    });

    if (response.ok) {
      showToast('üóëÔ∏è Riwayat berhasil dihapus!');
      addLog(`üóëÔ∏è Deleted session: ${sessionId}`);
      await loadHistory();
    } else {
      throw new Error('Delete failed: ' + response.status);
    }
  } catch (err) {
    showToast('‚ùå Gagal menghapus: ' + err.message, 3000);
    addLog('‚ùå Delete error: ' + err.message);
  }
}

// ============================================
// INIT
// ============================================
window.addEventListener('load', async function() {
  addLog('üöÄ SUNSTONE initializing...');
  try { await initIndexedDB(); }
  catch (err) { addLog('‚ùå IndexedDB failed: ' + err.message); alert('Database error!'); return; }
  await loadONNXModel();
  connectMQTT();

  const authToken = localStorage.getItem('authToken');
  if (authToken) {
    document.getElementById('loginPage').classList.remove('active');
    document.getElementById('dashboardPage').classList.add('active');
    await restoreSession();
  } else {
    setTimeout(()=>{ if (mqttClient && mqttConnected) sendMQTTCommand({ action:'no_session' }); }, 3000);
  }
  addLog('‚úÖ System ready!');

  setInterval(()=> {
    if (mqttClient && mqttConnected) {
      if (currentSessionId) sendMQTTCommand({ action:'session_active', session_id: currentSessionId });
      else sendMQTTCommand({ action:'no_session' });
    }
  }, 10000);
});

setInterval(()=> {
  if (currentSessionId && lastSensorTimestamp) {
    const secondsAgo = Math.floor((new Date() - lastSensorTimestamp) / 1000);
    if (secondsAgo > 10) {
      document.getElementById('lastUpdate').innerHTML = '‚ö†Ô∏è No data >10s';
      document.getElementById('lastUpdate').style.color = '#dc3545';
    }
  }
}, 5000);
</script>
</body>
</html>
