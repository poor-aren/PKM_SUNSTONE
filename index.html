<!DOCTYPE html> 
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SUNSTONE - Lung Health Monitoring</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:#f5f6fa;display:flex;justify-content:center;align-items:center;min-height:100vh}
    .container{max-width:1200px;width:100%;padding:20px}
    .page{display:none;background:#fff;border-radius:12px;box-shadow:0 4px 25px rgba(0,0,0,0.1);overflow:hidden}
    .page.active{display:block}
    .nav-btn{padding:10px 20px;border:2px solid #3b4998;background:#f8f9fa;color:#3b4998;border-radius:8px;cursor:pointer;font-weight:600;margin-right:10px;transition:0.3s}
    .nav-btn:hover,.nav-btn.active{background:#3b4998;color:#fff}
    .dashboard-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:2px solid #eee;flex-wrap:wrap}
    .dashboard-title{color:#3b4998;font-size:30px;font-weight:bold}
    .nav-links{display:flex;gap:5px;flex-wrap:wrap}
    .btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:0.3s}
    .btn-primary{background:#3b4998;color:#fff}
    .btn-primary:hover{background:#2d3875}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-danger:hover{background:#c82333}
    .btn-success{background:#28a745;color:#fff}
    .btn-success:hover{background:#218838}
    .btn-sm{padding:6px 10px;font-size:13px}
    .add-patient-section{background:#f8f9fa;padding:20px;border-radius:10px;margin:20px}
    .form-row{display:flex;gap:15px;margin-bottom:15px}
    .form-group{flex:1}
    .form-group label{font-weight:600;color:#333;display:block;margin-bottom:5px}
    .form-group input{width:100%;padding:10px;border:2px solid #ddd;border-radius:6px}
    .current-patient{background:#e3f2fd;padding:20px;border-left:4px solid #3b4998;border-radius:8px;margin:20px}
    .status-badge{padding:4px 12px;border-radius:12px;font-weight:600;font-size:12px;margin-left:10px}
    .status-waiting{background:#fff3cd;color:#856404}
    .status-processing{background:#cce5ff;color:#0066cc}
    .status-completed{background:#d4edda;color:#155724}
    .sensor-panel{background:#f8f9fa;padding:20px;border-radius:10px;margin:20px}
    .sensor-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:15px}
    .sensor-card{background:#fff;padding:15px;border-radius:8px;border-left:4px solid #3b4998;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .sensor-value{font-size:24px;font-weight:bold;color:#3b4998;margin:5px 0}
    .sensor-label{font-size:12px;color:#666;text-transform:uppercase}
    .result-section{background:#3b4998;color:white;padding:25px;border-radius:12px;margin:20px;display:none}
    .result-category{font-size:36px;font-weight:bold;margin:15px 0}
    .result-confidence{font-size:18px;margin-bottom:20px}
    .prob-bars{margin-top:20px}
    .prob-item{margin-bottom:10px}
    .prob-label{display:flex;justify-content:space-between;margin-bottom:5px;font-size:14px}
    .prob-bar{height:20px;background:rgba(255,255,255,0.2);border-radius:10px;overflow:hidden}
    .prob-fill{height:100%;background:#fff;transition:width 0.5s}
    .admin-page{padding:20px}
    .status-table{width:100%;border-collapse:collapse;margin-bottom:20px}
    .status-table th,.status-table td{padding:10px;border-bottom:1px solid #ddd;text-align:left}
    .status-table th{background:#f8f9fa;font-weight:600}
    .log-container{background:#f8f9fa;padding:10px;border-radius:8px;font-family:monospace;max-height:250px;overflow-y:auto;font-size:12px}
    .log-entry{border-bottom:1px dashed #ccc;padding:3px 0}
    table{width:100%;border-collapse:collapse;margin-top:15px}
    th,td{border-bottom:1px solid #ddd;padding:10px;text-align:left}
    th{background:#f8f9fa;font-weight:600}
    .toast{position:fixed;bottom:20px;right:20px;padding:15px 20px;background:#28a745;color:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);display:none;z-index:1000}
    .connection-indicator{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:5px}
    .conn-connected{background:#28a745}
    .conn-disconnected{background:#dc3545}
    .conn-connecting{background:#ffc107;animation:blink 1s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
  </style>
</head>
<body>
  <!-- (SEMUA BAGIAN BODY SAMA PERSIS SEPERTI VERSI 1 DI ATAS) -->
  <!-- Untuk ringkas, body/markup-nya identik; yang berbeda hanya fungsi runInference di script -->
  
  <!-- ... salinan markup dari Versi 1 sampai sebelum <script> ... (identik) ... -->

  <div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.20.0/dist/ort.min.js"></script>
<script src="https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js"></script>
<script>
// (SEMUA KONFIG, DB, MQTT, LOGIN, DLL SAMA PERSIS SEPERTI VERSI 1)
// === potongan awal sama persis; disingkat di sini demi fokus pada runInference ===

// ... [SELURUH KODE SAMA DENGAN VERSI 1 SAMPAI DEFINISI runInference] ...

// === VERSI 2: LABEL-ONLY (minta output_label saja)
async function runInference(sensorData) {
  addLog('ü§ñ Running inference...');
  addLog(`üìä Input data: MG811=${sensorData.mg811}, MQ7=${sensorData.mq7}, MQ3=${sensorData.mq3}, MQ135=${sensorData.mq135}`);
  
  if (!onnxSession) {
    addLog('‚ö†Ô∏è  No ONNX model - using fallback');
    const avg = (sensorData.mg811 + sensorData.mq7 + sensorData.mq3 + sensorData.mq135) / 4;
    // fallback simple
    const classes = ['Rendah','Sedang','Tinggi'];
    const idx = avg < 200 ? 0 : (avg < 350 ? 1 : 2);
    const category = classes[idx];
    // mapping bar UI (Normal, Ringan, Sedang, Berat)
    const probs4 = [
      idx===0?1:0, // Normal=Rendah
      idx===1?1:0, // Ringan=Sedang
      idx===2?1:0, // Sedang=Tinggi
      0            // Berat=0
    ];
    return { 
      category, 
      confidence: 1.0,
      probabilities: { normal:probs4[0], ringan:probs4[1], sedang:probs4[2], berat:probs4[3] }
    };
  }

  try {
    const inputName = onnxSession.inputNames[0] || 'float_input';
    const input = new Float32Array([sensorData.mg811, sensorData.mq7, sensorData.mq3, sensorData.mq135]);
    const tensor = new ort.Tensor('float32', input, [1, 4]);
    const feeds = { [inputName]: tensor };

    const wantedLabel = onnxSession.outputNames.find(n => /label/i.test(n)) || 'output_label';
    addLog('ü§ñ Running ONNX inference (label-only)...');
    const results = await onnxSession.run(feeds, [wantedLabel]);
    addLog('‚úÖ ONNX inference complete');

    const labelTensor = results[wantedLabel];
    if (!labelTensor || !labelTensor.data || labelTensor.data.length === 0) {
      throw new Error('label output empty');
    }

    const raw = labelTensor.data[0];
    const labelIdx = typeof raw === 'bigint' ? Number(raw) : Number(raw);
    const classes = ['Rendah','Sedang','Tinggi'];
    const category = classes[labelIdx] ?? 'Rendah';

    // Set bars: Normal=Rendah, Ringan=Sedang, Sedang=Tinggi, Berat=0
    const probs4 = [
      labelIdx===0?1:0,
      labelIdx===1?1:0,
      labelIdx===2?1:0,
      0
    ];

    return { 
      category, 
      confidence: 1.0, 
      probabilities: { normal:probs4[0], ringan:probs4[1], sedang:probs4[2], berat:probs4[3] }
    };
  } catch (error) {
    addLog('‚ùå Inference error (label-only): ' + error.message);
    addLog('‚ùå Error stack: ' + error.stack);
    return null;
  }
}

// ... [SISANYA SAMA PERSIS DENGAN VERSI 1: processSensorData, displayResult, dsb.] ...
</script>
</body>
</html>
