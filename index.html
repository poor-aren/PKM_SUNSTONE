<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SUNSTONE - Lung Health Monitoring</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:#f5f6fa;display:flex;justify-content:center;align-items:center;min-height:100vh}
    .container{max-width:1200px;width:100%;padding:20px}
    .page{display:none;background:#fff;border-radius:12px;box-shadow:0 4px 25px rgba(0,0,0,0.1);overflow:hidden}
    .page.active{display:block}
    .nav-btn{padding:10px 20px;border:2px solid #3b4998;background:#f8f9fa;color:#3b4998;border-radius:8px;cursor:pointer;font-weight:600;margin-right:10px;transition:0.3s}
    .nav-btn:hover,.nav-btn.active{background:#3b4998;color:#fff}
    .dashboard-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:2px solid #eee;flex-wrap:wrap}
    .dashboard-title{color:#3b4998;font-size:30px;font-weight:bold}
    .nav-links{display:flex;gap:5px;flex-wrap:wrap}
    .btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:0.3s}
    .btn-primary{background:#3b4998;color:#fff}
    .btn-primary:hover{background:#2d3875}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-danger:hover{background:#c82333}
    .btn-success{background:#28a745;color:#fff}
    .btn-success:hover{background:#218838}
    .btn-sm{padding:6px 10px;font-size:13px}
    .add-patient-section{background:#f8f9fa;padding:20px;border-radius:10px;margin:20px}
    .form-row{display:flex;gap:15px;margin-bottom:15px}
    .form-group{flex:1}
    .form-group label{font-weight:600;color:#333;display:block;margin-bottom:5px}
    .form-group input{width:100%;padding:10px;border:2px solid #ddd;border-radius:6px}
    .current-patient{background:#e3f2fd;padding:20px;border-left:4px solid #3b4998;border-radius:8px;margin:20px}
    .status-badge{padding:4px 12px;border-radius:12px;font-weight:600;font-size:12px;margin-left:10px}
    .status-waiting{background:#fff3cd;color:#856404}
    .status-processing{background:#cce5ff;color:#0066cc}
    .status-completed{background:#d4edda;color:#155724}
    .sensor-panel{background:#f8f9fa;padding:20px;border-radius:10px;margin:20px}
    .sensor-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:15px}
    .sensor-card{background:#fff;padding:15px;border-radius:8px;border-left:4px solid #3b4998;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .sensor-value{font-size:24px;font-weight:bold;color:#3b4998;margin:5px 0}
    .sensor-label{font-size:12px;color:#666;text-transform:uppercase}
    .result-section{background:#3b4998;color:white;padding:25px;border-radius:12px;margin:20px}
    .result-category{font-size:36px;font-weight:bold;margin:15px 0}
    .result-confidence{font-size:18px;margin-bottom:20px}
    .prob-bars{margin-top:20px}
    .prob-item{margin-bottom:10px}
    .prob-label{display:flex;justify-content:space-between;margin-bottom:5px;font-size:14px}
    .prob-bar{height:20px;background:rgba(255,255,255,0.2);border-radius:10px;overflow:hidden}
    .prob-fill{height:100%;background:#fff;transition:width 0.5s}
    .admin-page{padding:20px}
    .status-table{width:100%;border-collapse:collapse;margin-bottom:20px}
    .status-table th,.status-table td{padding:10px;border-bottom:1px solid #ddd;text-align:left}
    .status-table th{background:#f8f9fa;font-weight:600}
    .log-container{background:#f8f9fa;padding:10px;border-radius:8px;font-family:monospace;max-height:250px;overflow-y:auto;font-size:12px}
    .log-entry{border-bottom:1px dashed #ccc;padding:3px 0}
    table{width:100%;border-collapse:collapse;margin-top:15px}
    th,td{border-bottom:1px solid #ddd;padding:10px;text-align:left}
    th{background:#f8f9fa;font-weight:600}
    .alert{padding:15px;margin:20px;border-radius:8px;font-weight:600}
    .alert-warning{background:#fff3cd;color:#856404;border-left:4px solid #ffc107}
    .toast{position:fixed;bottom:20px;right:20px;padding:15px 20px;background:#28a745;color:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);display:none;z-index:1000}
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN PAGE -->
    <div id="loginPage" class="page active" style="text-align:center;padding:50px">
      <h1 style="color:#3b4998;margin-bottom:30px;">ü´Å SUNSTONE Admin Login</h1>
      <form id="loginForm" style="max-width:350px;margin:auto;">
        <input type="email" id="username" placeholder="Email" required style="padding:12px;width:100%;margin-bottom:15px;border:2px solid #ccc;border-radius:6px;">
        <input type="password" id="password" placeholder="Password" required style="padding:12px;width:100%;margin-bottom:15px;border:2px solid #ccc;border-radius:6px;">
        <button class="btn btn-primary" style="width:100%;" type="submit">Masuk</button>
      </form>
      <p id="loginError" style="color:red;margin-top:10px;"></p>
      <p style="color:#999;font-size:13px;margin-top:20px;">Browser-Centric Architecture ‚Ä¢ Offline-First</p>
    </div>

    <!-- DASHBOARD PAGE -->
    <div id="dashboardPage" class="page">
      <div class="dashboard-header">
        <h1 class="dashboard-title">DASHBOARD</h1>
        <div class="nav-links">
          <button class="nav-btn active" onclick="showDashboard(event)">Dashboard</button>
          <button class="nav-btn" onclick="showHistory(event)">Riwayat</button>
          <button class="nav-btn" onclick="showAdmin(event)">Admin</button>
          <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>
      </div>

      <!-- Add Patient Form -->
      <div id="addPatientSection" class="add-patient-section">
        <h3>Tambah Pasien Baru</h3>
        <form id="patientForm">
          <div class="form-row">
            <div class="form-group">
              <label>Nama Lengkap</label>
              <input id="patientName" type="text" required>
            </div>
            <div class="form-group">
              <label>Umur (tahun)</label>
              <input id="patientAge" type="number" required min="1" max="120">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>No HP</label>
              <input id="patientPhone" type="text" required pattern="[0-9]{10,13}" placeholder="08123456789">
            </div>
            <div class="form-group">
              <label>Index Brinkman</label>
              <input id="brinkmanIndex" type="number" required min="0" placeholder="Contoh: 600">
            </div>
          </div>
          <button class="btn btn-primary" type="submit">Mulai Sesi</button>
        </form>
      </div>

      <!-- Current Patient Info -->
      <div id="currentPatientSection" class="current-patient" style="display:none">
        <h4>üë§ Pasien Aktif <span id="patientStatus" class="status-badge status-waiting">Menunggu Data</span></h4>
        <p><b>Nama:</b> <span id="currentName">-</span> | <b>Umur:</b> <span id="currentAge">-</span> | <b>HP:</b> <span id="currentPhone">-</span> | <b>Brinkman:</b> <span id="currentBrinkman">-</span></p>
        <button class="btn btn-danger" onclick="finishSession()">Selesai & Tutup Sesi</button>
      </div>

      <!-- Sensor Panel (4 sensor only) -->
      <div id="sensorPanel" class="sensor-panel" style="display:none">
        <h3>üìä Data Sensor Real-time</h3>
        <p id="lastUpdate" style="color:#666;font-size:13px;margin-top:5px">Menunggu data dari ESP32...</p>
        <div class="sensor-grid">
          <div class="sensor-card">
            <div class="sensor-label">MG-811 (CO‚ÇÇ)</div>
            <div class="sensor-value" id="mg811">-</div>
            <div style="font-size:12px;color:#999">ppm</div>
          </div>
          <div class="sensor-card">
            <div class="sensor-label">MQ-7 (CO)</div>
            <div class="sensor-value" id="mq7">-</div>
            <div style="font-size:12px;color:#999">ppm</div>
          </div>
          <div class="sensor-card">
            <div class="sensor-label">MQ-3 (Etanol)</div>
            <div class="sensor-value" id="mq3">-</div>
            <div style="font-size:12px;color:#999">ppm</div>
          </div>
          <div class="sensor-card">
            <div class="sensor-label">MQ-135 (VOC)</div>
            <div class="sensor-value" id="mq135">-</div>
            <div style="font-size:12px;color:#999">ppm</div>
          </div>
        </div>
      </div>

      <!-- Result Section -->
      <div id="resultSection" class="result-section" style="display:none">
        <h3>üî¨ Hasil Analisis PPOK</h3>
        <div class="result-category" id="resultCategory">-</div>
        <div class="result-confidence">Confidence: <span id="resultConfidence">-</span>%</div>
        
        <div class="prob-bars">
          <div class="prob-item">
            <div class="prob-label"><span>Normal</span><span id="probNormal">0%</span></div>
            <div class="prob-bar"><div class="prob-fill" id="probNormalBar" style="width:0%"></div></div>
          </div>
          <div class="prob-item">
            <div class="prob-label"><span>Ringan</span><span id="probRingan">0%</span></div>
            <div class="prob-bar"><div class="prob-fill" id="probRinganBar" style="width:0%"></div></div>
          </div>
          <div class="prob-item">
            <div class="prob-label"><span>Sedang</span><span id="probSedang">0%</span></div>
            <div class="prob-bar"><div class="prob-fill" id="probSedangBar" style="width:0%"></div></div>
          </div>
          <div class="prob-item">
            <div class="prob-label"><span>Berat</span><span id="probBerat">0%</span></div>
            <div class="prob-bar"><div class="prob-fill" id="probBeratBar" style="width:0%"></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- HISTORY PAGE -->
    <div id="historyPage" class="page">
      <div class="dashboard-header">
        <h1 class="dashboard-title">RIWAYAT PEMERIKSAAN</h1>
        <div class="nav-links">
          <button class="nav-btn" onclick="showDashboard(event)">Dashboard</button>
          <button class="nav-btn active" onclick="showHistory(event)">Riwayat</button>
          <button class="nav-btn" onclick="showAdmin(event)">Admin</button>
          <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>
      </div>
      <div style="padding:20px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
          <button class="btn btn-primary" onclick="loadHistory()">üîÑ Refresh Data</button>
          <span id="syncIndicator" style="color:#999;font-size:13px"></span>
        </div>
        <table>
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>Nama Pasien</th>
              <th>Umur</th>
              <th>No HP</th>
              <th>Brinkman</th>
              <th>Hasil PPOK</th>
              <th>Confidence</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr><td colspan="8" style="text-align:center">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ADMIN PAGE -->
    <div id="adminPage" class="page">
      <div class="admin-page">
        <h1 style="color:#3b4998;margin-bottom:10px;">‚öôÔ∏è ADMIN PANEL - System Status</h1>
        <div class="nav-links" style="margin-bottom:15px">
          <button class="nav-btn" onclick="showDashboard(event)">Dashboard</button>
          <button class="nav-btn" onclick="showHistory(event)">Riwayat</button>
          <button class="nav-btn active" onclick="showAdmin(event)">Admin</button>
          <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>
        
        <h3>System Status</h3>
        <table class="status-table">
          <tr><th>Component</th><th>Status</th><th>Detail</th></tr>
          <tr>
            <td>üåê Koneksi Internet</td>
            <td id="netStatus">üü° Checking...</td>
            <td id="netDetail">-</td>
          </tr>
          <tr>
            <td>üóÑÔ∏è IndexedDB</td>
            <td id="dbStatus">üü° Checking...</td>
            <td id="dbDetail">-</td>
          </tr>
          <tr>
            <td>ü§ñ ONNX Model</td>
            <td id="modelStatus">üü° Checking...</td>
            <td id="modelDetail">-</td>
          </tr>
          <tr>
            <td>üì° ESP32 Status</td>
            <td id="esp32Status">üü° Waiting...</td>
            <td id="esp32Detail">-</td>
          </tr>
          <tr>
            <td>üîÑ Pending Sync (AWS)</td>
            <td id="syncStatus">üü° Checking...</td>
            <td id="syncDetail">-</td>
          </tr>
        </table>
        
        <button class="btn btn-primary" onclick="refreshSystemStatus()">Refresh Status</button>
        <button class="btn btn-success" style="margin-left:10px" onclick="forceSyncToAWS()">Force Sync to AWS</button>
        
        <h3 style="margin-top:30px;">System Logs</h3>
        <div id="logContainer" class="log-container">
          <div class="log-entry">[INIT] System initializing...</div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.min.js"></script>
<script>
// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
  users: {
    'pkmkc.sunstone@gmail.com': {
      passwordHash: 'e3c8d05a5d6e3e6b3f9f2a3a4e3c8d05a5d6e3e6b3f9f2a3a4e3c8d05a5d6e3e',
      name: 'Admin SUNSTONE'
    }
  },
  modelUrl: './sunstone_model.onnx',
  awsApiUrl: 'https://8308ialq3d.execute-api.ap-southeast-1.amazonaws.com/history',
  sensorPort: 3000,
  staleDataTimeout: 10000
};

// ============================================
// GLOBAL STATE
// ============================================
let db = null;
let onnxSession = null;
let currentSessionId = null;
let lastSensorTimestamp = null;
let esp32Server = null;

// ============================================
// UTILITY FUNCTIONS
// ============================================
async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  console.log('Hash generated:', hashHex); // DEBUG
  return hashHex;
}

function addLog(message) {
  const logContainer = document.getElementById('logContainer');
  if (!logContainer) return;
  const timestamp = new Date().toLocaleTimeString('id-ID');
  const logEntry = document.createElement('div');
  logEntry.className = 'log-entry';
  logEntry.textContent = `[${timestamp}] ${message}`;
  logContainer.appendChild(logEntry);
  logContainer.scrollTop = logContainer.scrollHeight;
  console.log(`[${timestamp}] ${message}`);
}

function showToast(message, duration = 3000) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, duration);
}

function generateSessionId(name, phone) {
  const cleanName = name.replace(/\s+/g, '_');
  return `${cleanName}_${phone}_${Date.now()}`;
}

// ============================================
// INDEXEDDB SETUP
// ============================================
async function initIndexedDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('SunstoneDB', 1);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      addLog('IndexedDB initialized');
      resolve(db);
    };
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      
      if (!db.objectStoreNames.contains('sessions')) {
        const sessionsStore = db.createObjectStore('sessions', { keyPath: 'id', autoIncrement: true });
        sessionsStore.createIndex('sessionId', 'sessionId', { unique: true });
        sessionsStore.createIndex('status', 'status', { unique: false });
      }
      
      if (!db.objectStoreNames.contains('sensors')) {
        const sensorsStore = db.createObjectStore('sensors', { keyPath: 'id', autoIncrement: true });
        sensorsStore.createIndex('sessionId', 'sessionId', { unique: false });
        sensorsStore.createIndex('timestamp', 'timestamp', { unique: false });
      }
      
      if (!db.objectStoreNames.contains('results')) {
        const resultsStore = db.createObjectStore('results', { keyPath: 'id', autoIncrement: true });
        resultsStore.createIndex('sessionId', 'sessionId', { unique: false });
      }
      
      if (!db.objectStoreNames.contains('syncQueue')) {
        db.createObjectStore('syncQueue', { keyPath: 'id', autoIncrement: true });
      }
      
      addLog('IndexedDB schema created');
    };
  });
}

// ============================================
// DATABASE OPERATIONS
// ============================================
async function saveSession(sessionData) {
  const tx = db.transaction(['sessions'], 'readwrite');
  const store = tx.objectStore('sessions');
  return new Promise((resolve, reject) => {
    const request = store.add(sessionData);
    request.onsuccess = () => resolve(sessionData.sessionId);
    request.onerror = () => reject(request.error);
  });
}

async function updateSession(sessionId, updates) {
  const tx = db.transaction(['sessions'], 'readwrite');
  const store = tx.objectStore('sessions');
  const index = store.index('sessionId');
  
  return new Promise((resolve, reject) => {
    const request = index.get(sessionId);
    request.onsuccess = () => {
      const session = request.result;
      if (session) {
        Object.assign(session, updates);
        const updateReq = store.put(session);
        updateReq.onsuccess = () => resolve(session);
        updateReq.onerror = () => reject(updateReq.error);
      } else {
        reject(new Error('Session not found'));
      }
    };
    request.onerror = () => reject(request.error);
  });
}

async function getActiveSession() {
  const tx = db.transaction(['sessions'], 'readonly');
  const store = tx.objectStore('sessions');
  const index = store.index('status');
  
  return new Promise((resolve) => {
    const request = index.get('OPEN');
    request.onsuccess = () => resolve(request.result || null);
    request.onerror = () => resolve(null);
  });
}

async function saveSensorData(sensorData) {
  const tx = db.transaction(['sensors'], 'readwrite');
  const store = tx.objectStore('sensors');
  return new Promise((resolve) => {
    const request = store.add(sensorData);
    request.onsuccess = () => resolve();
    request.onerror = () => resolve();
  });
}

async function saveResult(resultData) {
  const tx = db.transaction(['results'], 'readwrite');
  const store = tx.objectStore('results');
  return new Promise((resolve) => {
    const request = store.add(resultData);
    request.onsuccess = () => resolve();
    request.onerror = () => resolve();
  });
}

async function getAllSessions() {
  const tx = db.transaction(['sessions'], 'readonly');
  const store = tx.objectStore('sessions');
  
  return new Promise((resolve) => {
    const request = store.getAll();
    request.onsuccess = () => resolve(request.result || []);
    request.onerror = () => resolve([]);
  });
}

async function addToSyncQueue(type, data) {
  const tx = db.transaction(['syncQueue'], 'readwrite');
  const store = tx.objectStore('syncQueue');
  return new Promise((resolve) => {
    store.add({ type, data, attempts: 0, lastAttempt: null });
    resolve();
  });
}

// ============================================
// ONNX MODEL
// ============================================
async function loadONNXModel() {
  try {
    addLog('Loading ONNX model...');
    onnxSession = await ort.InferenceSession.create(CONFIG.modelUrl);
    addLog('‚úÖ ONNX model loaded successfully');
    return true;
  } catch (error) {
    addLog('‚ùå Error loading ONNX model: ' + error.message);
    addLog('‚ÑπÔ∏è  Pastikan file sunstone_model.onnx ada di folder yang sama');
    return false;
  }
}

async function runInference(sensorData) {
  if (!onnxSession) {
    addLog('‚ö†Ô∏è  ONNX model not loaded, using fallback');
    // Fallback logic
    const avg = (sensorData.mg811 + sensorData.mq7 + sensorData.mq3 + sensorData.mq135) / 4;
    if (avg < 200) return { category: 'Normal', confidence: 0.85, probabilities: {normal:0.85,ringan:0.10,sedang:0.03,berat:0.02} };
    if (avg < 350) return { category: 'Ringan', confidence: 0.78, probabilities: {normal:0.10,ringan:0.78,sedang:0.10,berat:0.02} };
    if (avg < 500) return { category: 'Sedang', confidence: 0.82, probabilities: {normal:0.05,ringan:0.15,sedang:0.82,berat:0.08} };
    return { category: 'Berat', confidence: 0.90, probabilities: {normal:0.02,ringan:0.05,sedang:0.13,berat:0.90} };
  }
  
  try {
    const input = new Float32Array([sensorData.mg811, sensorData.mq7, sensorData.mq3, sensorData.mq135]);
    const tensor = new ort.Tensor('float32', input, [1, 4]);
    const feeds = { float_input: tensor };
    
    const results = await onnxSession.run(feeds);
    const output = Array.from(results.output.data);
    
    const probabilities = {
      normal: output[0],
      ringan: output[1],
      sedang: output[2],
      berat: output[3]
    };
    
    const maxProb = Math.max(...output);
    const categories = ['Normal', 'Ringan', 'Sedang', 'Berat'];
    const category = categories[output.indexOf(maxProb)];
    
    return { category, confidence: maxProb, probabilities };
  } catch (error) {
    addLog('‚ùå Inference error: ' + error.message);
    return null;
  }
}

// ============================================
// LOGIN SYSTEM
// ============================================
document.getElementById('loginForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  console.log('Login attempt started');
  
  const email = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  
  console.log('Email:', email);
  console.log('Password length:', password.length);
  
  const passwordHash = await hashPassword(password);
  console.log('Generated hash:', passwordHash);
  
  const user = CONFIG.users[email];
  console.log('User found:', user ? 'YES' : 'NO');
  
  if (user) {
    console.log('Expected hash:', user.passwordHash);
    console.log('Hash match:', user.passwordHash === passwordHash);
  }
  
  if (user && user.passwordHash === passwordHash) {
    localStorage.setItem('authToken', btoa(`${email}:${Date.now()}`));
    localStorage.setItem('userName', user.name);
    console.log('‚úÖ Login SUCCESS');
    addLog(`‚úÖ Login berhasil: ${user.name}`);
    showToast('‚úÖ Login berhasil!');
    document.getElementById('loginError').textContent = '';
    document.getElementById('loginPage').classList.remove('active');
    document.getElementById('dashboardPage').classList.add('active');
    await restoreSession();
  } else {
    console.log('‚ùå Login FAILED');
    document.getElementById('loginError').textContent = '‚ùå Email atau password salah!';
    addLog('‚ùå Login gagal: kredensial tidak valid');
  }
});

function logout() {
  if (currentSessionId && !confirm('Sesi masih aktif. Yakin logout?')) return;
  
  localStorage.removeItem('authToken');
  localStorage.removeItem('userName');
  localStorage.removeItem('SESSION_KEY');
  currentSessionId = null;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('loginPage').classList.add('active');
  addLog('Logout berhasil');
  showToast('Logout berhasil');
}

// ============================================
// SESSION MANAGEMENT
// ============================================
document.getElementById('patientForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const existingSession = await getActiveSession();
  if (existingSession) {
    if (!confirm(`‚ö†Ô∏è Masih ada sesi aktif: ${existingSession.name}. Tutup sesi ini?`)) return;
    await updateSession(existingSession.sessionId, { 
      status: 'CLOSED',
      finishTimestamp: new Date().toISOString()
    });
    addLog(`Session ${existingSession.sessionId} ditutup otomatis`);
  }
  
  const name = document.getElementById('patientName').value;
  const age = parseInt(document.getElementById('patientAge').value);
  const phone = document.getElementById('patientPhone').value;
  const brinkman = parseInt(document.getElementById('brinkmanIndex').value);
  
  const sessionId = generateSessionId(name, phone);
  const sessionData = {
    sessionId,
    name,
    age,
    phone,
    brinkman,
    status: 'OPEN',
    timestamp: new Date().toISOString(),
    device_id: 'ESP01',
    lastResultCategory: null,
    lastResultConfidence: null,
    lastProbabilities: null,
    syncedToAWS: false
  };
  
  await saveSession(sessionData);
  localStorage.setItem('SESSION_KEY', sessionId);
  currentSessionId = sessionId;
  
  document.getElementById('currentName').textContent = name;
  document.getElementById('currentAge').textContent = age;
  document.getElementById('currentPhone').textContent = phone;
  document.getElementById('currentBrinkman').textContent = brinkman;
  document.getElementById('addPatientSection').style.display = 'none';
  document.getElementById('currentPatientSection').style.display = 'block';
  document.getElementById('sensorPanel').style.display = 'block';
  
  addLog(`‚úÖ Sesi dimulai: ${name} (${sessionId})`);
  showToast('‚úÖ Sesi berhasil dibuat!');
  
  // Background sync to AWS
  syncSessionToAWS(sessionData);
  
  // Start listening for ESP32 data
  startESP32Listener();
});

async function finishSession() {
  if (!currentSessionId) return;
  if (!confirm('Yakin tutup sesi ini?')) return;
  
  await updateSession(currentSessionId, {
    status: 'CLOSED',
    finishTimestamp: new Date().toISOString()
  });
  
  // Sync final state to AWS
  const session = await getActiveSession();
  if (session) syncSessionToAWS(session);
  
  resetDashboard();
  addLog(`‚úÖ Sesi selesai: ${currentSessionId}`);
  showToast('‚úÖ Sesi ditutup dan disimpan!');
}

function resetDashboard() {
  currentSessionId = null;
  localStorage.removeItem('SESSION_KEY');
  document.getElementById('addPatientSection').style.display = 'block';
  document.getElementById('currentPatientSection').style.display = 'none';
  document.getElementById('sensorPanel').style.display = 'none';
  document.getElementById('resultSection').style.display = 'none';
  document.getElementById('patientForm').reset();
}

async function restoreSession() {
  const sessionKey = localStorage.getItem('SESSION_KEY');
  if (!sessionKey) return;
  
  const tx = db.transaction(['sessions'], 'readonly');
  const store = tx.objectStore('sessions');
  const index = store.index('sessionId');
  
  return new Promise((resolve) => {
    const request = index.get(sessionKey);
    request.onsuccess = () => {
      const session = request.result;
      if (session && session.status === 'OPEN') {
        currentSessionId = session.sessionId;
        document.getElementById('currentName').textContent = session.name;
        document.getElementById('currentAge').textContent = session.age;
        document.getElementById('currentPhone').textContent = session.phone;
        document.getElementById('currentBrinkman').textContent = session.brinkman;
        document.getElementById('addPatientSection').style.display = 'none';
        document.getElementById('currentPatientSection').style.display = 'block';
        document.getElementById('sensorPanel').style.display = 'block';
        
        if (session.lastResultCategory) {
          displayResult({
            category: session.lastResultCategory,
            confidence: session.lastResultConfidence,
            probabilities: session.lastProbabilities
          });
        }
        
        addLog(`‚úÖ Sesi dipulihkan: ${session.name}`);
        startESP32Listener();
      }
      resolve();
    };
    request.onerror = () => resolve();
  });
}

// ============================================
// ESP32 DATA LISTENER (Browser receives HTTP POST)
// ============================================
function startESP32Listener() {
  addLog('üì° Menunggu data sensor dari ESP32...');
  // In production: ESP32 sends HTTP POST to this browser
  // For testing: simulate data every 2 seconds
  
  // IMPORTANT: This is simulation. Real implementation needs:
  // 1. Local HTTP server (Node.js/Python) running on admin's laptop
  // 2. ESP32 sends POST to http://LAPTOP_IP:3000/sensor
  // 3. Server forwards to browser via WebSocket or SSE
  
  // For demo purposes, simulate sensor data
  if (window.sensorSimInterval) clearInterval(window.sensorSimInterval);
  
  window.sensorSimInterval = setInterval(async () => {
    if (!currentSessionId) {
      clearInterval(window.sensorSimInterval);
      return;
    }
    
    // Simulate ESP32 sending data (4 sensors only!)
    const sensorData = {
      device_id: 'ESP01',
      timestamp: new Date().toISOString(),
      mg811: Math.floor(Math.random() * 200) + 300,  // 300-500
      mq7: Math.floor(Math.random() * 150) + 200,    // 200-350
      mq3: Math.floor(Math.random() * 100) + 150,    // 150-250
      mq135: Math.floor(Math.random() * 200) + 350   // 350-550
    };
    
    await processSensorData(sensorData);
  }, 2000);
}

async function processSensorData(sensorData) {
  if (!currentSessionId) return;
  
  // Validate timestamp (anti-bleed)
  const sensorTime = new Date(sensorData.timestamp);
  lastSensorTimestamp = sensorTime;
  
  // Save to IndexedDB
  const sensorRecord = {
    sessionId: currentSessionId,
    timestamp: sensorData.timestamp,
    mg811: sensorData.mg811,
    mq7: sensorData.mq7,
    mq3: sensorData.mq3,
    mq135: sensorData.mq135,
    syncedToAWS: false
  };
  await saveSensorData(sensorRecord);
  
  // Update UI
  document.getElementById('mg811').textContent = sensorData.mg811;
  document.getElementById('mq7').textContent = sensorData.mq7;
  document.getElementById('mq3').textContent = sensorData.mq3;
  document.getElementById('mq135').textContent = sensorData.mq135;
  
  const now = new Date();
  const secondsAgo = Math.floor((now - lastSensorTimestamp) / 1000);
  document.getElementById('lastUpdate').textContent = `‚è±Ô∏è Update: ${secondsAgo} detik lalu`;
  document.getElementById('lastUpdate').style.color = '#666';
  document.getElementById('patientStatus').textContent = 'Processing';
  document.getElementById('patientStatus').className = 'status-badge status-processing';
  
  // Run ONNX inference (INSTANT in browser!)
  const result = await runInference(sensorData);
  
  if (result) {
    // Save result
    const resultData = {
      sessionId: currentSessionId,
      timestamp: new Date().toISOString(),
      category: result.category,
      confidence: result.confidence,
      probabilities: result.probabilities,
      syncedToAWS: false
    };
    await saveResult(resultData);
    
    // Update session metadata
    await updateSession(currentSessionId, {
      lastResultCategory: result.category,
      lastResultConfidence: result.confidence,
      lastProbabilities: result.probabilities
    });
    
    // Display result
    displayResult(result);
    
    addLog(`üî¨ Inference: ${result.category} (${(result.confidence * 100).toFixed(1)}%)`);
  }
}

function displayResult(result) {
  document.getElementById('resultSection').style.display = 'block';
  document.getElementById('resultCategory').textContent = result.category;
  document.getElementById('resultConfidence').textContent = (result.confidence * 100).toFixed(1);
  
  document.getElementById('patientStatus').textContent = 'Selesai';
  document.getElementById('patientStatus').className = 'status-badge status-completed';
  
  if (result.probabilities) {
    const probs = result.probabilities;
    
    document.getElementById('probNormal').textContent = (probs.normal * 100).toFixed(1) + '%';
    document.getElementById('probNormalBar').style.width = (probs.normal * 100) + '%';
    
    document.getElementById('probRingan').textContent = (probs.ringan * 100).toFixed(1) + '%';
    document.getElementById('probRinganBar').style.width = (probs.ringan * 100) + '%';
    
    document.getElementById('probSedang').textContent = (probs.sedang * 100).toFixed(1) + '%';
    document.getElementById('probSedangBar').style.width = (probs.sedang * 100) + '%';
    
    document.getElementById('probBerat').textContent = (probs.berat * 100).toFixed(1) + '%';
    document.getElementById('probBeratBar').style.width = (probs.berat * 100) + '%';
  }
}

// ============================================
// AWS SYNC (Background, Non-blocking)
// ============================================
async function syncSessionToAWS(sessionData) {
  if (!navigator.onLine) {
    await addToSyncQueue('session', sessionData);
    addLog('‚ö†Ô∏è  Offline - ditambahkan ke sync queue');
    return;
  }
  
  try {
    const response = await fetch(CONFIG.awsApiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: sessionData.sessionId,
        name: sessionData.name,
        age: sessionData.age,
        phone: sessionData.phone,
        brinkman: sessionData.brinkman,
        timestamp: sessionData.timestamp,
        status: sessionData.status,
        lastResultCategory: sessionData.lastResultCategory,
        lastResultConfidence: sessionData.lastResultConfidence
      })
    });
    
    if (response.ok) {
      await updateSession(sessionData.sessionId, { syncedToAWS: true });
      addLog('‚òÅÔ∏è  Synced to AWS: ' + sessionData.sessionId);
    } else {
      await addToSyncQueue('session', sessionData);
      addLog('‚ö†Ô∏è  AWS sync failed, added to queue');
    }
  } catch (error) {
    await addToSyncQueue('session', sessionData);
    addLog('‚ö†Ô∏è  AWS sync error: ' + error.message);
  }
}

async function forceSyncToAWS() {
  if (!navigator.onLine) {
    showToast('‚ùå Tidak ada koneksi internet');
    return;
  }
  
  addLog('üîÑ Force sync to AWS...');
  const sessions = await getAllSessions();
  let synced = 0;
  
  for (const session of sessions) {
    if (!session.syncedToAWS) {
      await syncSessionToAWS(session);
      synced++;
    }
  }
  
  showToast(`‚úÖ ${synced} sesi berhasil disinkronkan`);
  addLog(`‚úÖ Force sync complete: ${synced} items`);
}

// ============================================
// PAGE NAVIGATION
// ============================================
function showDashboard(e) {switchPage('dashboardPage', e);}
function showHistory(e) {switchPage('historyPage', e); loadHistory();}
function showAdmin(e) {switchPage('adminPage', e); refreshSystemStatus();}

function switchPage(pageId, event) {
  if (event) {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
  }
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
}

// ============================================
// HISTORY
// ============================================
async function loadHistory() {
  const tbody = document.getElementById('historyBody');
  tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">Loading...</td></tr>';
  
  try {
    const sessions = await getAllSessions();
    
    // Sort by timestamp descending
    sessions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    if (sessions.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">Belum ada data</td></tr>';
      document.getElementById('syncIndicator').textContent = '';
      return;
    }
    
    const pendingSync = sessions.filter(s => !s.syncedToAWS).length;
    if (pendingSync > 0) {
      document.getElementById('syncIndicator').innerHTML = `üì± Mode offline (${pendingSync} sesi belum sync)`;
    } else {
      document.getElementById('syncIndicator').innerHTML = `üåê Tersinkron dengan cloud`;
    }
    
    tbody.innerHTML = sessions.map(session => {
      const date = new Date(session.timestamp).toLocaleString('id-ID');
      const statusColor = session.status === 'OPEN' ? '#28a745' : '#6c757d';
      const statusIcon = session.status === 'OPEN' ? 'üü¢' : 'üî¥';
      
      return `
        <tr>
          <td>${date}</td>
          <td>${session.name}</td>
          <td>${session.age}</td>
          <td>${session.phone}</td>
          <td>${session.brinkman}</td>
          <td>${session.lastResultCategory || '-'}</td>
          <td>${session.lastResultConfidence ? (session.lastResultConfidence * 100).toFixed(1) + '%' : '-'}</td>
          <td style="color:${statusColor};font-weight:600">${statusIcon} ${session.status}</td>
        </tr>
      `;
    }).join('');
    
    addLog(`üìã History loaded: ${sessions.length} records`);
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:red">Error: ${err.message}</td></tr>`;
    addLog('‚ùå Error loading history: ' + err.message);
  }
}

// ============================================
// ADMIN PANEL
// ============================================
async function refreshSystemStatus() {
  addLog('üîç Checking system status...');
  
  // Check Internet
  if (navigator.onLine) {
    updateStatus('net', true, 'Online');
  } else {
    updateStatus('net', false, 'Offline');
  }
  
  // Check IndexedDB
  if (db) {
    const sessions = await getAllSessions();
    const size = Math.floor(JSON.stringify(sessions).length / 1024);
    updateStatus('db', true, `${sessions.length} sessions (${size}KB)`);
  } else {
    updateStatus('db', false, 'Not initialized');
  }
  
  // Check ONNX Model
  if (onnxSession) {
    updateStatus('model', true, 'Loaded and ready');
  } else {
    updateStatus('model', false, 'Not loaded - using fallback');
  }
  
  // Check ESP32
  if (lastSensorTimestamp) {
    const secondsAgo = Math.floor((new Date() - lastSensorTimestamp) / 1000);
    if (secondsAgo < 5) {
      updateStatus('esp32', true, `Active (${secondsAgo}s ago)`);
    } else if (secondsAgo < 30) {
      updateStatus('esp32', null, `Idle (${secondsAgo}s ago)`);
    } else {
      updateStatus('esp32', false, `Disconnected (${secondsAgo}s ago)`);
    }
  } else {
    updateStatus('esp32', null, 'Waiting for data');
  }
  
  // Check Pending Sync
  const sessions = await getAllSessions();
  const pendingSync = sessions.filter(s => !s.syncedToAWS).length;
  if (pendingSync === 0) {
    updateStatus('sync', true, 'All synced');
  } else {
    updateStatus('sync', null, `${pendingSync} items pending`);
  }
}

function updateStatus(service, isOk, detail) {
  const statusEl = document.getElementById(`${service}Status`);
  const detailEl = document.getElementById(`${service}Detail`);
  
  if (isOk === true) {
    statusEl.textContent = 'üü¢ OK';
    statusEl.style.color = 'green';
  } else if (isOk === false) {
    statusEl.textContent = 'üî¥ Error';
    statusEl.style.color = 'red';
  } else {
    statusEl.textContent = 'üü° Warning';
    statusEl.style.color = 'orange';
  }
  
  if (detailEl) detailEl.textContent = detail || '-';
}

// ============================================
// INITIALIZATION
// ============================================
window.addEventListener('load', async function() {
  addLog('üöÄ SUNSTONE System initializing...');
  addLog('‚ÑπÔ∏è  Architecture: Browser-Centric (Offline-First)');
  
  // TEMPORARY: Generate correct hash for password
  const correctPassword = 'pkmkcsunstone2025';
  const correctHash = await hashPassword(correctPassword);
  console.log('====================================');
  console.log('CORRECT PASSWORD HASH:');
  console.log(correctHash);
  console.log('====================================');
  console.log('Copy hash di atas dan ganti di CONFIG.users');
  
  try {
    await initIndexedDB();
  } catch (err) {
    addLog('‚ùå Failed to initialize IndexedDB: ' + err.message);
    alert('Database initialization failed. Please check console.');
    return;
  }
  
  await loadONNXModel();
  
  const authToken = localStorage.getItem('authToken');
  if (authToken) {
    addLog('‚úÖ Auto-login detected');
    document.getElementById('loginPage').classList.remove('active');
    document.getElementById('dashboardPage').classList.add('active');
    await restoreSession();
  }
  
  addLog('‚úÖ SUNSTONE System ready!');
});

// Monitor stale sensor data
setInterval(() => {
  if (currentSessionId && lastSensorTimestamp) {
    const timeSinceUpdate = Date.now() - lastSensorTimestamp.getTime();
    if (timeSinceUpdate > CONFIG.staleDataTimeout) {
      document.getElementById('lastUpdate').innerHTML = '‚ö†Ô∏è Tidak ada data sensor >10 detik<br><small>Tunggu pasien meniup sensor atau cek koneksi ESP32</small>';
      document.getElementById('lastUpdate').style.color = '#dc3545';
    }
  }
}, 5000);

// Handle online/offline events
window.addEventListener('online', () => {
  addLog('üåê Internet connected');
  showToast('üåê Kembali online - sync otomatis dimulai');
  forceSyncToAWS();
});

window.addEventListener('offline', () => {
  addLog('üì± Internet disconnected - entering offline mode');
  showToast('üì± Mode offline aktif');
});
</script>
</body>
</html>
