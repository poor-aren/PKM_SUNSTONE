<!DOCTYPE html>
<!DOCTYPE html> 
<html lang="id">
<head>
  <meta charset="UTF-8" />
@@ -152,28 +152,24 @@ <h3>üìä Data Sensor Real-time</h3>
        </div>
      </div>

      <!-- Result Section -->
      <!-- Result Section (disesuaikan: 3 kelas) -->
      <div id="resultSection" class="result-section">
        <h3>üî¨ Hasil Analisis PPOK</h3>
        <div class="result-category" id="resultCategory">-</div>
        <div class="result-confidence">Confidence: <span id="resultConfidence">-</span>%</div>

        <div class="prob-bars">
          <div class="prob-item">
            <div class="prob-label"><span>Normal</span><span id="probNormal">0%</span></div>
            <div class="prob-bar"><div class="prob-fill" id="probNormalBar" style="width:0%"></div></div>
          </div>
          <div class="prob-item">
            <div class="prob-label"><span>Ringan</span><span id="probRingan">0%</span></div>
            <div class="prob-bar"><div class="prob-fill" id="probRinganBar" style="width:0%"></div></div>
            <div class="prob-label"><span>Rendah</span><span id="probRendah">0%</span></div>
            <div class="prob-bar"><div class="prob-fill" id="probRendahBar" style="width:0%"></div></div>
          </div>
          <div class="prob-item">
            <div class="prob-label"><span>Sedang</span><span id="probSedang">0%</span></div>
            <div class="prob-bar"><div class="prob-fill" id="probSedangBar" style="width:0%"></div></div>
          </div>
          <div class="prob-item">
            <div class="prob-label"><span>Berat</span><span id="probBerat">0%</span></div>
            <div class="prob-bar"><div class="prob-fill" id="probBeratBar" style="width:0%"></div></div>
            <div class="prob-label"><span>Tinggi</span><span id="probTinggi">0%</span></div>
            <div class="prob-bar"><div class="prob-fill" id="probTinggiBar" style="width:0%"></div></div>
          </div>
        </div>
      </div>
@@ -591,55 +587,137 @@ <h3 style="margin-top:30px;">System Logs</h3>
  addLog(`üìä Input data: MG811=${sensorData.mg811}, MQ7=${sensorData.mq7}, MQ3=${sensorData.mq3}, MQ135=${sensorData.mq135}`);

  if (!onnxSession) {
    addLog('‚ö†Ô∏è  No ONNX model - using fallback');
    addLog('‚ö†Ô∏è  No ONNX model - using fallback (3 kelas)');
    const avg = (sensorData.mg811 + sensorData.mq7 + sensorData.mq3 + sensorData.mq135) / 4;
    addLog(`üìä Average sensor value: ${avg.toFixed(2)}`);

    let result;
    if (avg < 200) {
      result = { category: 'Normal', confidence: 0.85, probabilities: {normal:0.85,ringan:0.10,sedang:0.03,berat:0.02} };
    } else if (avg < 350) {
      result = { category: 'Ringan', confidence: 0.78, probabilities: {normal:0.10,ringan:0.78,sedang:0.10,berat:0.02} };
    } else if (avg < 500) {
      result = { category: 'Sedang', confidence: 0.82, probabilities: {normal:0.05,ringan:0.15,sedang:0.72,berat:0.08} };
    if (avg < 250) {
      result = { category: 'Rendah', confidence: 0.80, probabilities: {rendah:0.80, sedang:0.15, tinggi:0.05} };
    } else if (avg < 400) {
      result = { category: 'Sedang', confidence: 0.78, probabilities: {rendah:0.10, sedang:0.78, tinggi:0.12} };
    } else {
      result = { category: 'Berat', confidence: 0.90, probabilities: {normal:0.02,ringan:0.05,sedang:0.13,berat:0.80} };
      result = { category: 'Tinggi', confidence: 0.85, probabilities: {rendah:0.05, sedang:0.20, tinggi:0.75} };
    }

    addLog(`‚úÖ Fallback result: ${result.category} (${(result.confidence * 100).toFixed(1)}%)`);
    return result;
  }

  try {
    // Siapkan input tensor
    addLog('üîß Preparing tensor input...');
    const input = new Float32Array([sensorData.mg811, sensorData.mq7, sensorData.mq3, sensorData.mq135]);
    const tensor = new ort.Tensor('float32', input, [1, 4]);
    
    addLog('üîß Input names: ' + JSON.stringify(onnxSession.inputNames));
    const inputName = onnxSession.inputNames[0];
    const feeds = {};
    feeds[inputName] = tensor;
    const feeds = { [inputName]: tensor };

    // Jalankan inference
    addLog('ü§ñ Running ONNX inference...');
    const results = await onnxSession.run(feeds);
    addLog('‚úÖ ONNX inference complete');
    addLog('üîé Output names: ' + JSON.stringify(onnxSession.outputNames));

    // Robust parsing:
    // - Cari output 'probabilities' (Map dari ZipMap) ATAU Tensor probabilitas
    // - Cari output 'label' (Tensor/Scalar)
    let probsObj = null;          // jika Map (label->prob)
    let probsTensorArr = null;    // jika Tensor float [1,N]
    let labelValue = null;        // string/int prediksi

    const outputName = onnxSession.outputNames[0];
    const output = Array.from(results[outputName].data);
    addLog(`üìä ONNX output: [${output.map(v => v.toFixed(4)).join(', ')}]`);
    
    for (const name of onnxSession.outputNames) {
      const out = results[name];
      const hasData = (out && typeof out === 'object' && 'data' in out && Array.isArray(out.data));
      // ort.Tensor check sederhana:
      const isTensor = hasData && ('dims' in out);

      if (isTensor) {
        // Tensor output
        addLog(`üî¨ Tensor output '${name}' dims=${JSON.stringify(out.dims)} len=${out.data.length}`);
        // Heuristik: jika panjang data > 1, anggap ini probabilitas
        if (out.data.length > 1) {
          probsTensorArr = Array.from(out.data);
        } else {
          // Bisa jadi ini label id (int/float)
          labelValue = out.data[0];
        }
      } else {
        // Bukan Tensor ‚Üí kemungkinan besar Map dari ZipMap
        if (out && typeof out === 'object') {
          const keys = Object.keys(out);
          // Heuristik: jika terdapat key & value numerik ‚Üí ini Map probabilities
          if (keys.length && typeof out[keys[0]] === 'number') {
            probsObj = out;
            addLog(`üß≠ Detected ZipMap at output '${name}' with keys: ${keys.join(', ')}`);
          } else if (keys.length === 0) {
            addLog(`‚ÑπÔ∏è Output '${name}' is object but empty keys.`);
          }
        } else {
          addLog(`‚ÑπÔ∏è Output '${name}' is of type ${typeof out}`);
        }
      }
    }

    // Urutan label target UI (3 kelas):
    const UI_LABELS = ['Rendah','Sedang','Tinggi'];
    const UI_KEYS   = ['rendah','sedang','tinggi']; // untuk object probs

    // Bentuk array probabilitas [Rendah, Sedang, Tinggi]
    let probsArr = [0,0,0];
    if (probsObj) {
      // Map label->prob. Normalisasi key agar tahan terhadap variasi kapitalisasi/spasi.
      const norm = s => String(s).trim().toLowerCase();
      const lookup = {};
      for (const k of Object.keys(probsObj)) {
        lookup[norm(k)] = probsObj[k];
      }
      probsArr = [
        lookup['rendah'] ?? 0,
        lookup['sedang'] ?? 0,
        lookup['tinggi'] ?? 0
      ];
    } else if (probsTensorArr) {
      // Tensor probabilitas: asumsikan urutannya sama dengan label encoder saat ekspor
      // Kalau urutan model = [Rendah,Sedang,Tinggi], maka langsung pakai.
      // Jika berbeda, silakan sesuaikan mapping di sini.
      if (probsTensorArr.length === 3) {
        probsArr = probsTensorArr.slice(0,3);
      } else {
        addLog(`‚ö†Ô∏è Unexpected probs tensor length: ${probsTensorArr.length}. Trunc/pad to 3.`);
        probsArr = [
          probsTensorArr[0] ?? 0,
          probsTensorArr[1] ?? 0,
          probsTensorArr[2] ?? 0
        ];
      }
    } else {
      addLog('‚ö†Ô∏è No probabilities found in outputs; fallback evenly.');
      probsArr = [0.34, 0.33, 0.33];
    }

    // Tentukan kategori & confidence
    const maxProb = Math.max(...probsArr);
    const maxIdx = probsArr.indexOf(maxProb);
    let category = UI_LABELS[maxIdx];

    // Jika ada output label (string/int), boleh override kategori jika cocok
    if (labelValue !== null && labelValue !== undefined) {
      const labelStr = String(labelValue);
      const labelNorm = labelStr.trim().toLowerCase();
      const idxByLabel = UI_LABELS.map(s => s.toLowerCase()).indexOf(labelNorm);
      if (idxByLabel >= 0) {
        category = UI_LABELS[idxByLabel];
      }
    }

    // Bangun objek probabilitas untuk UI (keys: rendah/sedang/tinggi)
    const probabilities = {
      normal: output[0],
      ringan: output[1],
      sedang: output[2],
      berat: output[3]
      rendah: probsArr[0],
      sedang: probsArr[1],
      tinggi: probsArr[2]
    };
    
    const maxProb = Math.max(...output);
    const categories = ['Normal', 'Ringan', 'Sedang', 'Berat'];
    const category = categories[output.indexOf(maxProb)];
    
    addLog(`‚úÖ ONNX result: ${category} (${(maxProb * 100).toFixed(1)}%)`);

    addLog(`‚úÖ ONNX result: ${category} (${(maxProb * 100).toFixed(1)}%) | probs=${JSON.stringify(probabilities)}`);
    return { category, confidence: maxProb, probabilities };
  } catch (error) {
    addLog('‚ùå Inference error: ' + error.message);
@@ -734,6 +812,7 @@ <h3 style="margin-top:30px;">System Logs</h3>
  document.getElementById('currentAge').textContent = age;
  document.getElementById('currentPhone').textContent = phone;
  document.getElementById('currentBrinkman').textContent = brinkman;
  document.getElementById('addPatientSection').style.display = 'block' ? 'block' : 'block';
  document.getElementById('addPatientSection').style.display = 'none';
  document.getElementById('currentPatientSection').style.display = 'block';
  document.getElementById('sensorPanel').style.display = 'block';
@@ -899,22 +978,25 @@ <h3 style="margin-top:30px;">System Logs</h3>
  document.getElementById('patientStatus').className = 'status-badge status-completed';

  if (result.probabilities) {
    addLog('üìä Setting probability bars...');
    const probs = result.probabilities;
    addLog('üìä Setting probability bars (3 kelas)...');
    const probs = result.probabilities; // {rendah, sedang, tinggi}

    document.getElementById('probNormal').textContent = (probs.normal * 100).toFixed(1) + '%';
    document.getElementById('probNormalBar').style.width = (probs.normal * 100) + '%';
    
    document.getElementById('probRingan').textContent = (probs.ringan * 100).toFixed(1) + '%';
    document.getElementById('probRinganBar').style.width = (probs.ringan * 100) + '%';
    const clip01 = v => Math.max(0, Math.min(1, Number(v) || 0));

    const pr = clip01(probs.rendah);
    const ps = clip01(probs.sedang);
    const pt = clip01(probs.tinggi);

    document.getElementById('probRendah').textContent = (pr * 100).toFixed(1) + '%';
    document.getElementById('probRendahBar').style.width = (pr * 100) + '%';

    document.getElementById('probSedang').textContent = (probs.sedang * 100).toFixed(1) + '%';
    document.getElementById('probSedangBar').style.width = (probs.sedang * 100) + '%';
    document.getElementById('probSedang').textContent = (ps * 100).toFixed(1) + '%';
    document.getElementById('probSedangBar').style.width = (ps * 100) + '%';

    document.getElementById('probBerat').textContent = (probs.berat * 100).toFixed(1) + '%';
    document.getElementById('probBeratBar').style.width = (probs.berat * 100) + '%';
    document.getElementById('probTinggi').textContent = (pt * 100).toFixed(1) + '%';
    document.getElementById('probTinggiBar').style.width = (pt * 100) + '%';

    addLog('‚úÖ Probability bars updated');
    addLog('‚úÖ Probability bars updated (Rendah/Sedang/Tinggi)');
  } else {
    addLog('‚ö†Ô∏è No probabilities in result');
  }
