<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SUNSTONE ‚Äì Dashboard ML</title>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.min.js"></script>
  <script src="https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#0a0e27; color:#e0e6f1; }
    .container { max-width:980px; margin:20px auto; padding:20px; }
    h1, h2 { color:#64ffda; margin-bottom:15px; }
    .page { display:none; }
    .page.active { display:block; }
    nav { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    nav button { background:#1e2a47; color:#64ffda; border:1px solid #64ffda; padding:10px 18px; border-radius:6px; cursor:pointer; }
    nav button:hover { background:#2c3e64; }
    form { background:#1e2a47; padding:20px; border-radius:10px; margin-bottom:20px; }
    form input { width:100%; padding:10px; margin-bottom:10px; border:1px solid #3a506b; background:#0f1624; color:#fff; border-radius:4px; }
    form button { background:#64ffda; color:#0a0e27; border:none; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:600; }
    form button:hover { background:#52d4c2; }
    .info-box { background:#1e2a47; padding:15px; border-radius:8px; margin-bottom:15px; border-left:4px solid #64ffda; }
    .sensor-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:20px; }
    .sensor-card { background:#1e2a47; padding:15px; border-radius:8px; text-align:center; }
    .sensor-card .label { color:#8a9aaf; font-size:14px; margin-bottom:8px; }
    .sensor-card .value { font-size:28px; font-weight:700; color:#64ffda; }
    .result-box { background:#1e2a47; padding:20px; border-radius:10px; margin-bottom:20px; border:2px solid #ffd700; }
    .result-box h3 { color:#ffd700; margin-bottom:15px; }
    .result-main { font-size:32px; font-weight:700; text-align:center; margin-bottom:15px; }
    .result-confidence { text-align:center; color:#64ffda; font-size:18px; margin-bottom:20px; }
    .prob-list { display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:10px; }
    .prob-item { background:#0f1624; padding:10px; border-radius:6px; text-align:center; }
    .prob-item .label { color:#8a9aaf; font-size:14px; }
    .prob-item .value { font-size:20px; font-weight:600; color:#64ffda; margin-top:5px; }
    #loginError { color:#ff5370; margin-top:10px; }
    table { width:100%; background:#1e2a47; border-radius:8px; overflow:hidden; }
    table th { background:#2c3e64; padding:12px; text-align:left; color:#64ffda; }
    table td { padding:10px; border-bottom:1px solid #3a506b; }
  </style>
</head>
<body>
  <div class="container">

    <!-- LOGIN -->
    <section id="loginPage" class="page active">
      <h1>SUNSTONE Login</h1>
      <form id="loginForm">
        <input id="username" type="email" placeholder="Email" required>
        <input id="password" type="password" placeholder="Password" required>
        <button type="submit">Masuk</button>
      </form>
      <p id="loginError"></p>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboardPage" class="page">
      <nav>
        <button onclick="nav('dashboardPage')">Dashboard</button>
        <button onclick="nav('historyPage')">Riwayat</button>
        <button onclick="nav('adminPage')">Admin</button>
        <button onclick="logout()">Logout</button>
      </nav>

      <h1>Dashboard</h1>

      <!-- Form Mulai Sesi -->
      <form id="patientForm">
        <input id="patientName" required placeholder="Nama Pasien">
        <input id="patientAge" type="number" required placeholder="Umur">
        <input id="patientPhone" required placeholder="No HP">
        <input id="brinkmanIndex" type="number" required placeholder="Indeks Brinkman">
        <button type="submit">Mulai Sesi</button>
      </form>

      <!-- Info Sesi Aktif -->
      <div id="currentSession" style="display:none;">
        <div class="info-box">
          <strong>Pasien:</strong> <span id="currentName">-</span><br>
          <strong>Status MQTT:</strong> <span id="mqttStatusText">Connecting‚Ä¶</span>
        </div>
        <button onclick="finishSession()" style="background:#ff5370; color:#fff; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">Tutup Sesi</button>
      </div>

      <!-- Data Sensor -->
      <div id="sensorPanel" style="display:none; margin-top:20px;">
        <h2>Data Sensor Real-Time</h2>
        <div class="sensor-grid">
          <div class="sensor-card"><div class="label">MG-811 (CO‚ÇÇ)</div><div class="value" id="mg811">-</div></div>
          <div class="sensor-card"><div class="label">MQ-7 (CO)</div><div class="value" id="mq7">-</div></div>
          <div class="sensor-card"><div class="label">MQ-3 (Etanol)</div><div class="value" id="mq3">-</div></div>
          <div class="sensor-card"><div class="label">MQ-135 (VOC)</div><div class="value" id="mq135">-</div></div>
        </div>
        <div class="info-box" id="lastUpdate">Menunggu data‚Ä¶</div>
      </div>

      <!-- Hasil Analisis -->
      <div id="resultSection" style="display:none;">
        <div class="result-box">
          <h3>üîç Hasil Analisis Machine Learning</h3>
          <div class="result-main" id="resultCategory">-</div>
          <div class="result-confidence">Confidence: <span id="resultConfidence">-</span>%</div>
          <div class="prob-list">
            <div class="prob-item"><div class="label">Rendah</div><div class="value" id="probRendah">0%</div></div>
            <div class="prob-item"><div class="label">Sedang</div><div class="value" id="probSedang">0%</div></div>
            <div class="prob-item"><div class="label">Tinggi</div><div class="value" id="probTinggi">0%</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIWAYAT -->
    <section id="historyPage" class="page">
      <nav>
        <button onclick="nav('dashboardPage')">Dashboard</button>
        <button onclick="nav('historyPage')">Riwayat</button>
        <button onclick="nav('adminPage')">Admin</button>
        <button onclick="logout()">Logout</button>
      </nav>
      <h1>Riwayat Pemeriksaan</h1>
      <table>
        <thead><tr><th>Tanggal</th><th>Nama</th><th>Hasil</th><th>Confidence</th></tr></thead>
        <tbody id="historyBody"><tr><td colspan="4">Belum ada data</td></tr></tbody>
      </table>
    </section>

    <!-- ADMIN -->
    <section id="adminPage" class="page">
      <nav>
        <button onclick="nav('dashboardPage')">Dashboard</button>
        <button onclick="nav('historyPage')">Riwayat</button>
        <button onclick="nav('adminPage')">Admin</button>
        <button onclick="logout()">Logout</button>
      </nav>
      <h1>Status Sistem</h1>
      <table>
        <tr><th>Komponen</th><th>Status</th></tr>
        <tr><td>MQTT Broker</td><td id="mqttBrokerStatus">Checking‚Ä¶</td></tr>
        <tr><td>IndexedDB</td><td id="dbStatus">Checking‚Ä¶</td></tr>
        <tr><td>ONNX Model</td><td id="modelStatus">Checking‚Ä¶</td></tr>
        <tr><td>ESP32 Data</td><td id="esp32Status">Waiting‚Ä¶</td></tr>
      </table>
    </section>

  </div>

  <script>
  // ---- CONFIG ----
  const CONFIG = {
    users: { 'pkmkc.sunstone@gmail.com': { passwordHash: '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918', name: 'Admin' } },
    modelUrl: './sunstone_model.onnx',
    mqtt: {
      broker: 'wss://broker.hivemq.com:8884/mqtt',
      clientId: 'sunstone_web_' + Math.random().toString(16).slice(2),
      topics: { sensor: 'sunstone/esp32/+/sensor', cmd: 'sunstone/esp32/ESP01/cmd' }
    }
  };

  let db, currentSessionId, onnxSession, mqttClient, mqttConnected = false, lastSensorTime;

  // ---- Helpers ----
  async function hashPassword(p) {
    const b = new TextEncoder().encode(p);
    const h = await crypto.subtle.digest('SHA-256', b);
    return [...new Uint8Array(h)].map(x => x.toString(16).padStart(2, '0')).join('');
  }
  function nav(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }
  function logout() {
    if (confirm('Logout?')) { localStorage.removeItem('authToken'); localStorage.removeItem('SESSION_KEY'); location.reload(); }
  }

  // ---- IndexedDB ----
  function initDB() {
    return new Promise((res, rej) => {
      const req = indexedDB.open('SunstoneDB', 1);
      req.onupgradeneeded = e => {
        const d = e.target.result;
        d.createObjectStore('sessions', { keyPath: 'id', autoIncrement: true }).createIndex('sessionId', 'sessionId', { unique: true });
        d.createObjectStore('sensors', { keyPath: 'id', autoIncrement: true }).createIndex('sessionId', 'sessionId');
        d.createObjectStore('results', { keyPath: 'id', autoIncrement: true }).createIndex('sessionId', 'sessionId');
      };
      req.onsuccess = () => { db = req.result; res(); };
      req.onerror = () => rej(req.error);
    });
  }

  // ---- Login ----
  loginForm.addEventListener('submit', async e => {
    e.preventDefault();
    const ok = CONFIG.users[username.value.trim()]?.passwordHash === await hashPassword(password.value);
    if (!ok) { loginError.textContent = 'Email/Password salah'; return; }
    localStorage.setItem('authToken', 'ok');
    nav('dashboardPage');
    restoreSession();
  });

  // ---- Session (ATURAN KETAT: HANYA 1 SESI) ----
  patientForm.addEventListener('submit', async e => {
    e.preventDefault();
    // Tutup sesi lama kalau ada
    if (currentSessionId) await finishSession();

    currentSessionId = `${patientName.value}_${patientPhone.value}_${Date.now()}`;
    localStorage.setItem('SESSION_KEY', currentSessionId);
    currentName.textContent = patientName.value;
    currentSession.style.display = 'block';
    sensorPanel.style.display = 'block';
    resultSection.style.display = 'none'; // Reset hasil saat mulai sesi baru

    // Beri tahu simulator: sesi ready
    if (mqttConnected) {
      mqttClient.publish(CONFIG.mqtt.topics.cmd, JSON.stringify({
        action: 'session_ready',
        session_id: currentSessionId,
        patient_name: patientName.value
      }));
    }

    patientForm.reset();
  });

  async function finishSession() {
    if (!currentSessionId) return;
    // Publish close_session
    if (mqttConnected) {
      mqttClient.publish(CONFIG.mqtt.topics.cmd, JSON.stringify({ action: 'close_session' }));
    }
    localStorage.removeItem('SESSION_KEY');
    currentSessionId = null;
    currentSession.style.display = 'none';
    sensorPanel.style.display = 'none';
    resultSection.style.display = 'none';
  }

  function restoreSession() {
    const k = localStorage.getItem('SESSION_KEY');
    if (k) {
      currentSessionId = k;
      currentSession.style.display = 'block';
      sensorPanel.style.display = 'block';
    }
  }

  // ---- MQTT ----
  function connectMQTT() {
    mqttClient = mqtt.connect(CONFIG.mqtt.broker, { clientId: CONFIG.mqtt.clientId, clean: true, reconnectPeriod: 3000 });
    mqttClient.on('connect', () => {
      mqttConnected = true;
      mqttStatusText.textContent = 'Connected';
      mqttBrokerStatus.textContent = '‚úÖ Connected';
      mqttClient.subscribe(CONFIG.mqtt.topics.sensor);
    });
    mqttClient.on('message', async (topic, payload) => {
      if (!currentSessionId) return; // BLOKIR data saat tidak ada sesi
      const d = JSON.parse(payload.toString());
      lastSensorTime = Date.now();

      // Update UI sensor
      mg811.textContent = d.mg811;
      mq7.textContent = d.mq7;
      mq3.textContent = d.mq3;
      mq135.textContent = d.mq135;
      lastUpdate.textContent = 'Update: baru saja';
      esp32Status.textContent = '‚úÖ Receiving data';

      // Inference
      const r = await runInference(d);
      if (r) showResult(r);
    });
    mqttClient.on('close', () => { mqttConnected = false; mqttStatusText.textContent = 'Disconnected'; mqttBrokerStatus.textContent = '‚ùå Disconnected'; });
  }

  // ---- ONNX ----
  async function loadONNXModel() {
    try {
      onnxSession = await ort.InferenceSession.create(CONFIG.modelUrl);
      modelStatus.textContent = '‚úÖ Model loaded';
    } catch {
      onnxSession = null;
      modelStatus.textContent = '‚ö†Ô∏è Fallback mode';
    }
  }

  async function runInference(s) {
    if (!onnxSession) {
      // Fallback sederhana
      const avg = (s.mg811 + s.mq7 + s.mq3 + s.mq135) / 4;
      if (avg < 200) return { category: 'Rendah', confidence: 0.85, probabilities: { rendah: 0.85, sedang: 0.10, tinggi: 0.05 } };
      if (avg < 350) return { category: 'Sedang', confidence: 0.78, probabilities: { rendah: 0.10, sedang: 0.78, tinggi: 0.12 } };
      return { category: 'Tinggi', confidence: 0.90, probabilities: { rendah: 0.02, sedang: 0.08, tinggi: 0.90 } };
    }

    // ONNX inference (sesuaikan nama input/output model kamu)
    const input = new ort.Tensor('float32', new Float32Array([s.mg811, s.mq7, s.mq3, s.mq135]), [1, 4]);
    const out = await onnxSession.run({ float_input: input });
    const arr = Array.from(out.output.data);
    const categories = ['Rendah', 'Sedang', 'Tinggi'];
    const i = arr.indexOf(Math.max(...arr));
    return {
      category: categories[i],
      confidence: arr[i],
      probabilities: { rendah: arr[0], sedang: arr[1], tinggi: arr[2] }
    };
  }

  function showResult(r) {
    resultSection.style.display = 'block';
    resultCategory.textContent = r.category;
    resultConfidence.textContent = (r.confidence * 100).toFixed(1);
    probRendah.textContent = (r.probabilities.rendah * 100).toFixed(1) + '%';
    probSedang.textContent = (r.probabilities.sedang * 100).toFixed(1) + '%';
    probTinggi.textContent = (r.probabilities.tinggi * 100).toFixed(1) + '%';
  }

  // ---- Init ----
  window.addEventListener('load', async () => {
    await initDB();
    dbStatus.textContent = '‚úÖ Ready';
    await loadONNXModel();
    connectMQTT();
    if (localStorage.getItem('authToken')) { nav('dashboardPage'); restoreSession(); }

    // Monitor stale data >10s
    setInterval(() => {
      if (currentSessionId && lastSensorTime && ((Date.now() - lastSensorTime) / 1000 > 10)) {
        lastUpdate.textContent = '‚ö†Ô∏è No data >10s';
        esp32Status.textContent = '‚ö†Ô∏è Connection lost';
      }
    }, 5000);
  });
  </script>
</body>
</html>
